<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>K-COH Calculator - MIFIDPRU Compliant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{--bg:#0a0e1a;--panel:rgba(30,41,59,.55);--border:#334155;--accent:#10b981;--accent-hi:#34d399;--muted:#9ca3af;--subtle:#6b7280;--cash:#8b5cf6;--deriv:#e11d48}
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:var(--bg);color:#e0e7ff;font-family:Inter,system-ui,sans-serif;line-height:1.6}
    .container{max-width:1200px;margin:0 auto}
    h1{margin:0 0 36px;text-align:center;font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,#10b981,#3b82f6);-webkit-background-clip:text;color:transparent}
    .subtitle{text-align:center;margin:-20px 0 30px;color:var(--muted);font-size:1.1rem}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:1rem;padding:24px;margin-bottom:24px;backdrop-filter:blur(10px)}
    .card:hover{border-color:var(--accent);transition:border-color 0.3s}
    h2{margin:0 0 16px;color:#93c5fd;font-weight:600;font-size:1.3rem}
    .input{width:100%;padding:.75rem;border-radius:.5rem;background:#1e293b;border:1px solid var(--border);color:#e0e7ff;font-size:1rem}
    .select{width:100%;padding:.75rem;border-radius:.5rem;background:#1e293b;border:1px solid var(--border);color:#e0e7ff;cursor:pointer;font-size:1rem}
    .label{display:block;margin:0 0 .5rem;color:var(--muted);font-weight:500}
    .btn{background:linear-gradient(135deg,var(--accent),var(--accent-hi));color:#fff;border:0;padding:.75rem 2rem;border-radius:.5rem;font-weight:600;cursor:pointer;font-size:1rem;transition:transform 0.2s}
    .btn:hover{transform:translateY(-2px)}
    .btn:active{transform:translateY(0)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .stat{background:#0f172a;border:1px solid #1e293b;border-radius:.75rem;padding:16px}
    .stat h3{margin:0 0 8px;font-size:.9rem;color:var(--muted);font-weight:500;text-transform:uppercase;letter-spacing:0.5px}
    .stat p{margin:0;font-size:1.5rem;font-weight:700}
    .stat.primary{border-color:var(--accent);background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(59,130,246,0.1))}
    .stat.cash{border-color:var(--cash)}
    .stat.deriv{border-color:var(--deriv)}
    .badge{display:inline-block;padding:4px 8px;border-radius:.375rem;font-size:.8rem;font-weight:600;margin-left:8px}
    .ok{background:#15803d;color:#bbf7d0}
    .warn{background:#ca8a04;color:#fef08a}
    .err{background:#b91c1c;color:#fecaca}
    .note{color:var(--subtle);font-size:.9rem;margin-top:.5rem}
    canvas{background:#0f172a;border-radius:.75rem;border:1px solid #1e293b}
    .mt{margin-top:20px}
    .mb{margin-bottom:20px}
    .debug{background:#1e293b;padding:16px;border-radius:.5rem;font-family:monospace;font-size:.85rem;max-height:300px;overflow-y:auto;white-space:pre-wrap;border:1px solid var(--border)}
    .info-box{background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(59,130,246,0.1));border:1px solid var(--accent);border-radius:.75rem;padding:16px;margin-bottom:20px}
    .info-box strong{color:#34d399}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:768px){.row{grid-template-columns:1fr}}
    .formula{background:#0f172a;border:1px solid var(--border);border-radius:.5rem;padding:16px;margin:16px 0;font-family:monospace;font-size:.9rem;overflow-x:auto}
    .formula-title{color:var(--accent);font-weight:600;margin-bottom:8px}
    .timeline{display:flex;align-items:center;justify-content:space-between;margin:20px 0;padding:20px;background:#0f172a;border-radius:.75rem;border:1px solid var(--border)}
    .timeline-item{text-align:center;flex:1;position:relative}
    .timeline-item::after{content:'→';position:absolute;right:-20px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .timeline-item:last-child::after{display:none}
    .timeline-period{color:var(--accent);font-weight:600;font-size:.9rem}
    .timeline-desc{color:var(--muted);font-size:.8rem;margin-top:4px}
    .excluded{opacity:0.5;text-decoration:line-through}
    .spinner{border:3px solid rgba(255,255,255,0.1);border-radius:50%;border-top-color:var(--accent);width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>K-COH Calculator</h1>
    <p class="subtitle">MIFIDPRU Compliant • 6-Month Rolling Average</p>

    <div class="card">
      <h2>Instructions & Requirements</h2>
      <div class="content">
        <div class="info-box">
          <strong>CSV Format Required:</strong> Three columns - Date, Cash_COH, Derivatives_COH<br>
          <strong>Date formats accepted:</strong> dd.mm.yyyy, dd/mm/yyyy, dd-mm-yyyy, yyyy-mm-dd<br>
          <strong>Values:</strong> Use 0 or leave blank where not applicable
        </div>
        
        <label class="label" for="csv">Upload COH Data (CSV)</label>
        <input id="csv" class="input" type="file" accept=".csv,text/csv" />
        <div id="fileInfo" class="note"></div>
        
        <div class="row mt">
          <div>
            <label class="label" for="currency">Reporting Currency</label>
            <select id="currency" class="select">
              <option value="GBP">GBP (£)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div>
            <label class="label" for="own">Own Funds</label>
            <input id="own" class="input" type="number" placeholder="50000000" value="50000000" />
          </div>
        </div>
        
        <div class="mt mb">
          <button class="btn" id="calculate">Calculate K-COH</button>
        </div>
        
        <div id="debugPanel" class="debug" style="display:none"></div>
      </div>
    </div>

    <div class="card" id="methodCard" style="display:none">
      <h2>Calculation Methodology</h2>
      <div class="content">
        <div class="timeline">
          <div class="timeline-item">
            <div class="timeline-period">Month 6</div>
            <div class="timeline-desc">6 months ago</div>
          </div>
          <div class="timeline-item">
            <div class="timeline-period">Month 5</div>
            <div class="timeline-desc">5 months ago</div>
          </div>
          <div class="timeline-item">
            <div class="timeline-period">Month 4</div>
            <div class="timeline-desc">4 months ago</div>
          </div>
          <div class="timeline-item excluded">
            <div class="timeline-period">Month 3</div>
            <div class="timeline-desc">Excluded</div>
          </div>
          <div class="timeline-item excluded">
            <div class="timeline-period">Month 2</div>
            <div class="timeline-desc">Excluded</div>
          </div>
          <div class="timeline-item excluded">
            <div class="timeline-period">Month 1</div>
            <div class="timeline-desc">Excluded</div>
          </div>
        </div>
        
        <div class="formula">
          <div class="formula-title">MIFIDPRU Formula:</div>
          1. Take daily COH for past 6 months<br>
          2. Exclude most recent 3 months<br>
          3. Average remaining 3 months (months 4-6)<br>
          4. K-COH (Cash) = Average Cash COH × 0.1%<br>
          5. K-COH (Derivatives) = Average Derivatives COH × 0.01%<br>
          6. K-COH Total = K-COH (Cash) + K-COH (Derivatives)
        </div>
        
        <div id="calcDetails" class="note mt"></div>
      </div>
    </div>

    <div class="card" id="resultsCard" style="display:none">
      <h2>K-COH Requirements</h2>
      <div class="content">
        <div class="grid mb">
          <div class="stat cash">
            <h3>K-COH (Cash)</h3>
            <p id="kcohCash">£0</p>
            <div class="note">0.1% of average Cash COH</div>
          </div>
          <div class="stat deriv">
            <h3>K-COH (Derivatives)</h3>
            <p id="kcohDeriv">£0</p>
            <div class="note">0.01% of average Derivatives COH</div>
          </div>
          <div class="stat primary">
            <h3>K-COH Total</h3>
            <p id="kcohTotal">£0</p>
            <div class="note">Combined requirement</div>
          </div>
        </div>
        
        <div class="grid">
          <div class="stat">
            <h3>Average Cash COH</h3>
            <p id="avgCash">£0</p>
          </div>
          <div class="stat">
            <h3>Average Derivatives COH</h3>
            <p id="avgDeriv">£0</p>
          </div>
          <div class="stat">
            <h3>Headroom Ratio</h3>
            <p id="headroom">0%</p>
          </div>
        </div>
        
        <div id="dataInfo" class="note mt"></div>
      </div>
    </div>

    <div class="card" id="chartsCard" style="display:none">
      <h2>COH Trends</h2>
      <div class="content">
        <canvas id="trendChart" height="120"></canvas>
        <div class="mt">
          <canvas id="breakdownChart" height="80"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
// Currency symbols
const CURRENCY_SYMBOLS = {
  'GBP': '£',
  'USD': '$',
  'EUR': '€',
  'OTHER': ''
};

// Parse European date formats
function parseDate(dateStr) {
  const s = dateStr.trim();
  if (!s) return null;
  
  // Try different date formats
  if (/^\d{1,2}[.\/-]\d{1,2}[.\/-]\d{4}$/.test(s)) {
    const parts = s.split(/[.\/-]/);
    const [d, m, y] = parts;
    return new Date(y, m-1, d);
  }
  
  if (/^\d{8}$/.test(s)) {
    return new Date(s.slice(4,8), s.slice(2,4)-1, s.slice(0,2));
  }
  
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    return new Date(s);
  }
  
  return null;
}

// Format date as yyyy-mm-dd
function formatDate(date) {
  return date.toISOString().split('T')[0];
}

// Format currency
function formatCurrency(value, currency) {
  const symbol = CURRENCY_SYMBOLS[currency];
  return symbol + value.toLocaleString('en-GB', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

// Parse CSV
function parseCSV(text) {
  const debug = document.getElementById('debugPanel');
  debug.style.display = 'block';
  debug.textContent = '=== CSV Processing ===\n';
  
  // Remove BOM if present
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  
  // Split into lines
  const lines = text.trim().split(/\r?\n/);
  debug.textContent += `Total lines: ${lines.length}\n`;
  
  // Parse header
  const headers = lines[0].toLowerCase().split(/[,;\t]/).map(h => h.trim());
  debug.textContent += `Headers: [${headers.join(', ')}]\n`;
  
  // Find columns
  const dateIdx = headers.findIndex(h => h.includes('date'));
  const cashIdx = headers.findIndex(h => h.includes('cash'));
  const derivIdx = headers.findIndex(h => h.includes('deriv'));
  
  if (dateIdx === -1) throw new Error('Date column not found');
  if (cashIdx === -1 && derivIdx === -1) throw new Error('Neither Cash_COH nor Derivatives_COH column found');
  
  debug.textContent += `Column indices - Date: ${dateIdx}, Cash: ${cashIdx}, Derivatives: ${derivIdx}\n\n`;
  
  // Parse data
  const data = new Map();
  let errors = 0;
  
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(/[,;\t]/);
    if (parts.length <= dateIdx) continue;
    
    const date = parseDate(parts[dateIdx]);
    if (!date) {
      errors++;
      if (errors <= 3) debug.textContent += `Line ${i+1}: Invalid date "${parts[dateIdx]}"\n`;
      continue;
    }
    
    const dateStr = formatDate(date);
    const cash = cashIdx >= 0 ? parseFloat(parts[cashIdx]?.replace(/[,\s]/g, '') || '0') : 0;
    const deriv = derivIdx >= 0 ? parseFloat(parts[derivIdx]?.replace(/[,\s]/g, '') || '0') : 0;
    
    if (!data.has(dateStr)) {
      data.set(dateStr, { cash: 0, deriv: 0 });
    }
    
    // Aggregate if multiple entries for same date
    const existing = data.get(dateStr);
    existing.cash += isNaN(cash) ? 0 : cash;
    existing.deriv += isNaN(deriv) ? 0 : deriv;
  }
  
  debug.textContent += `\nParsing complete:\n`;
  debug.textContent += `- Valid dates: ${data.size}\n`;
  debug.textContent += `- Parse errors: ${errors}\n`;
  
  if (data.size > 0) {
    const dates = Array.from(data.keys()).sort();
    debug.textContent += `- Date range: ${dates[0]} to ${dates[dates.length-1]}\n`;
  }
  
  return data;
}

// Calculate K-COH using MIFIDPRU methodology
function calculateKCOH(data) {
  const debug = document.getElementById('debugPanel');
  debug.textContent += '\n=== K-COH Calculation ===\n';
  
  // Get all dates sorted
  const allDates = Array.from(data.keys()).sort();
  if (allDates.length === 0) throw new Error('No data to calculate');
  
  const endDate = new Date(allDates[allDates.length - 1]);
  const sixMonthsAgo = new Date(endDate);
  sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
  
  debug.textContent += `Calculation date: ${formatDate(endDate)}\n`;
  debug.textContent += `6 months ago: ${formatDate(sixMonthsAgo)}\n`;
  
  // Get dates in 6-month window
  const sixMonthDates = allDates.filter(d => new Date(d) > sixMonthsAgo && new Date(d) <= endDate);
  debug.textContent += `Dates in 6-month window: ${sixMonthDates.length}\n`;
  
  // Calculate which 3 months to exclude
  const threeMonthsAgo = new Date(endDate);
  threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
  
  debug.textContent += `3 months ago (cutoff): ${formatDate(threeMonthsAgo)}\n`;
  
  // Get dates to average (months 4-6)
  const datesToAverage = sixMonthDates.filter(d => new Date(d) <= threeMonthsAgo);
  debug.textContent += `Dates to average (months 4-6): ${datesToAverage.length}\n`;
  
  if (datesToAverage.length === 0) {
    debug.textContent += '\nWARNING: No data in months 4-6, using all available data\n';
    datesToAverage.push(...sixMonthDates);
  }
  
  // Calculate averages
  let totalCash = 0, totalDeriv = 0;
  datesToAverage.forEach(date => {
    const day = data.get(date);
    totalCash += day.cash;
    totalDeriv += day.deriv;
  });
  
  const avgCash = datesToAverage.length > 0 ? totalCash / datesToAverage.length : 0;
  const avgDeriv = datesToAverage.length > 0 ? totalDeriv / datesToAverage.length : 0;
  
  // Apply coefficients
  const kcohCash = avgCash * 0.001;  // 0.1%
  const kcohDeriv = avgDeriv * 0.0001; // 0.01%
  const kcohTotal = kcohCash + kcohDeriv;
  
  debug.textContent += `\nCalculation results:\n`;
  debug.textContent += `- Average Cash COH: ${avgCash.toLocaleString('en-GB')}\n`;
  debug.textContent += `- Average Derivatives COH: ${avgDeriv.toLocaleString('en-GB')}\n`;
  debug.textContent += `- K-COH (Cash): ${kcohCash.toLocaleString('en-GB')}\n`;
  debug.textContent += `- K-COH (Derivatives): ${kcohDeriv.toLocaleString('en-GB')}\n`;
  debug.textContent += `- K-COH Total: ${kcohTotal.toLocaleString('en-GB')}\n`;
  
  return {
    avgCash,
    avgDeriv,
    kcohCash,
    kcohDeriv,
    kcohTotal,
    allDates,
    sixMonthDates,
    datesToAverage,
    endDate,
    sixMonthsAgo,
    threeMonthsAgo
  };
}

// Draw charts
let trendChart = null, breakdownChart = null;

function drawCharts(data, results, currency) {
  // Trend chart
  if (trendChart) trendChart.destroy();
  
  const ctx1 = document.getElementById('trendChart').getContext('2d');
  const dates = results.sixMonthDates.slice(-90); // Last 90 days
  const cashValues = dates.map(d => data.get(d).cash);
  const derivValues = dates.map(d => data.get(d).deriv);
  
  trendChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Cash COH',
        data: cashValues,
        borderColor: '#8b5cf6',
        backgroundColor: 'rgba(139, 92, 246, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }, {
        label: 'Derivatives COH',
        data: derivValues,
        borderColor: '#e11d48',
        backgroundColor: 'rgba(225, 29, 72, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          labels: { color: '#e0e7ff' }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.raw, currency);
            }
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(51, 65, 85, 0.3)' },
          ticks: { 
            color: '#9ca3af',
            maxRotation: 45,
            minRotation: 45,
            autoSkip: true,
            maxTicksLimit: 15
          }
        },
        y: {
          grid: { color: 'rgba(51, 65, 85, 0.3)' },
          ticks: { 
            color: '#9ca3af',
            callback: function(value) {
              const symbol = CURRENCY_SYMBOLS[currency];
              if (value >= 1000000) return symbol + (value/1000000).toFixed(1) + 'M';
              if (value >= 1000) return symbol + (value/1000).toFixed(0) + 'K';
              return symbol + value;
            }
          }
        }
      }
    }
  });
  
  // Breakdown chart
  if (breakdownChart) breakdownChart.destroy();
  
  const ctx2 = document.getElementById('breakdownChart').getContext('2d');
  breakdownChart = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['Cash K-COH', 'Derivatives K-COH'],
      datasets: [{
        data: [results.kcohCash, results.kcohDeriv],
        backgroundColor: ['#8b5cf6', '#e11d48'],
        borderColor: ['#a78bfa', '#f43f5e'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return formatCurrency(context.raw, currency);
            }
          }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(51, 65, 85, 0.3)' },
          ticks: { 
            color: '#9ca3af',
            callback: function(value) {
              return formatCurrency(value, currency);
            }
          }
        },
        y: {
          grid: { display: false },
          ticks: { color: '#e0e7ff' }
        }
      }
    }
  });
}

// Main calculation
function runCalculation() {
  try {
    const fileInput = document.getElementById('csv');
    if (!fileInput.files.length) {
      alert('Please select a CSV file');
      return;
    }
    
    const currency = document.getElementById('currency').value;
    const ownFunds = parseFloat(document.getElementById('own').value) || 50000000;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        // Parse CSV
        const data = parseCSV(e.target.result);
        
        if (data.size === 0) {
          alert('No valid data found in CSV');
          return;
        }
        
        // Calculate K-COH
        const results = calculateKCOH(data);
        
        // Display results
        document.getElementById('kcohCash').textContent = formatCurrency(results.kcohCash, currency);
        document.getElementById('kcohDeriv').textContent = formatCurrency(results.kcohDeriv, currency);
        document.getElementById('kcohTotal').textContent = formatCurrency(results.kcohTotal, currency);
        
        document.getElementById('avgCash').textContent = formatCurrency(results.avgCash, currency);
        document.getElementById('avgDeriv').textContent = formatCurrency(results.avgDeriv, currency);
        
        const headroom = ((ownFunds - results.kcohTotal) / ownFunds * 100).toFixed(2);
        document.getElementById('headroom').textContent = headroom + '%';
        
        // Data info
        const info = document.getElementById('dataInfo');
        info.innerHTML = `Data period: ${results.allDates[0]} to ${results.allDates[results.allDates.length-1]} (${results.allDates.length} days)<br>`;
        info.innerHTML += `Calculation window: ${formatDate(results.sixMonthsAgo)} to ${formatDate(results.endDate)}<br>`;
        info.innerHTML += `Averaged period: ${formatDate(results.sixMonthsAgo)} to ${formatDate(results.threeMonthsAgo)} (${results.datesToAverage.length} days)`;
        
        // Calculation details
        const calcDetails = document.getElementById('calcDetails');
        calcDetails.innerHTML = `Using ${results.datesToAverage.length} days from months 4-6 for averaging<br>`;
        calcDetails.innerHTML += `Excluded ${results.sixMonthDates.length - results.datesToAverage.length} days from most recent 3 months`;
        
        // Draw charts
        drawCharts(data, results, currency);
        
        // Show all cards
        document.getElementById('methodCard').style.display = 'block';
        document.getElementById('resultsCard').style.display = 'block';
        document.getElementById('chartsCard').style.display = 'block';
        
      } catch (error) {
        alert('Error: ' + error.message);
        console.error(error);
      }
    };
    
    reader.readAsText(fileInput.files[0]);
    
  } catch (error) {
    alert('Error: ' + error.message);
    console.error(error);
  }
}

// Event handlers
document.getElementById('csv').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    document.getElementById('fileInfo').textContent = 
      `Selected: ${file.name} (${(file.size/1024).toFixed(1)} KB)`;
    document.getElementById('debugPanel').style.display = 'none';
  }
});

document.getElementById('calculate').addEventListener('click', runCalculation);

// Set Chart.js defaults
Chart.defaults.color = '#e0e7ff';
Chart.defaults.borderColor = '#334155';
</script>
</body>
</html>