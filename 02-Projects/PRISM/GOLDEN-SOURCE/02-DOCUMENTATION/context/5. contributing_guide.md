# Contributing Guide - AI-Assisted Development

## Overview

This guide establishes standards and workflows for AI-assisted development of the ICARA/MiFIDPRU Platform. Given the regulatory nature of this financial software, your sophisticated calculator suite (FOR 2.0, KFR with SNI intelligence, industry-first SA-CCR K-TCD implementation, Risk Assessment with velocity factors), and the solo founder + AI development model, these guidelines ensure code quality, regulatory compliance, and systematic development practices.

**Core Principle**: "In a battle between theory and practice, practice wins every single time" - All guidelines focus on practical, working solutions over theoretical perfection.

**Quality Standard**: Financial regulatory software demands absolute accuracy. Every contribution must maintain calculation precision and audit trail integrity for institutional clients.

**Your Context**: 20+ years City of London financial services expertise + AI-assisted implementation = Revolutionary regulatory compliance software.

---

## Development Philosophy

### 1. AI-Assisted Development Model for Financial Software

#### The Human-AI Partnership for Regulatory Compliance
```
Human Contributions (Your Domain):
├── 20+ years financial services domain expertise
├── Regulatory requirement interpretation (MiFIDPRU, ICARA)
├── Business logic validation and commercial decisions
├── Calculator functionality specification (FOR 2.0, SA-CCR, etc.)
├── Quality assurance and regulatory testing oversight
├── Client requirement analysis and market validation

AI Contributions (Technical Implementation):
├── Code implementation and TypeScript structure
├── Technical architecture guidance and best practices
├── Testing strategy implementation and automation
├── Documentation generation and maintenance
├── Performance optimization and security implementation
├── Integration patterns and API design
```

#### Core Development Principles for Calculator Platform

**Regulatory Transparency Over Complexity**: Code must be readable and auditable by FCA and other regulatory authorities. Prefer explicit, documented implementations over clever abstractions.

**Calculation Accuracy Over Performance**: Penny-perfect accuracy takes absolute precedence over performance optimization. Every calculation must match regulatory examples exactly.

**Audit Trail Over Convenience**: Every action must be traceable for regulatory compliance. Maintain complete calculation history and user activity logs.

**Validation Over Assumption**: Never assume financial mathematics. Every calculation must be validated against known regulatory standards and cross-checked with HTML prototypes.

**Industry Standards Over Innovation**: Follow established financial services patterns. Your calculator platform serves institutional clients who expect familiar, compliant approaches.

**Documentation Over Memory**: AI-assisted development generates complex code requiring comprehensive documentation for future maintenance and regulatory review.

### 2. Code Quality Standards for Financial Software

#### Regulatory Compliance Requirements
```typescript
// ✅ GOOD: Explicit calculation with complete regulatory reference
/**
 * Calculate Fixed Overhead Requirement (FOR) per MiFIDPRU 4.5
 * 
 * @param prescribedCosts - Annual prescribed costs in GBP
 * @returns FOR value (25% of prescribed costs) rounded to nearest penny
 * 
 * @regulatory MiFIDPRU 4.5.1R: FOR = 25% of prescribed costs
 * @regulatory MiFIDPRU 4.5.3R: Excludes one-off items
 * @example 
 * // Annual costs of £800,000 → FOR of £200,000
 * const forValue = calculateFOR(800000); // Returns 200000
 */
function calculateFOR(prescribedCosts: number): number {
  // Validate input per regulatory requirements
  if (prescribedCosts < 0) {
    throw new CalculationError('Prescribed costs cannot be negative', 'FOR', { prescribedCosts });
  }
  
  // Apply MiFIDPRU 4.5.1R: FOR = 25% of prescribed costs
  const forValue = prescribedCosts * 0.25;
  
  // Ensure penny accuracy per UK financial services standards
  return Math.round(forValue * 100) / 100;
}

// ❌ BAD: Unclear calculation without regulatory basis or validation
function calc(costs: number): number {
  return costs * 0.25;
}
```

#### TypeScript Standards for Financial Calculations
```typescript
// ✅ GOOD: Comprehensive type safety with regulatory validation
interface FORCalculationInput {
  firmInfo: {
    name: string;
    fcaReference: string; // Exactly 6 digits per FCA requirements
    financialYear: string; // YYYY format
    calculationPurpose: 'annual' | 'interim' | 'stress-test' | 'scenario';
  };
  
  // Dual approach system from your FOR 2.0 calculator
  approach: 'consolidated' | 'granular';
  
  // Consolidated approach
  totalExpenditure?: number;
  
  // Granular approach (6 categories, 24 subcategories)
  costCategories?: {
    staff: CostCategory;
    professional: CostCategory;
    technology: CostCategory;
    occupancy: CostCategory;
    regulatory: CostCategory;
    other: CostCategory;
  };
  
  // FOR adjustments per MiFIDPRU 4.5.3R
  adjustments?: Array<{
    id: number;
    description: string; // Must document reason for adjustment
    amount: number; // Can be negative
    date: string; // ISO 8601 format
    regulatoryBasis: string; // Reference to regulation
  }>;
}

interface CostCategory {
  name: string;
  value: number; // Automatically calculated from subcategories
  icon: string; // For UI display
  subcategories: Record<string, {
    name: string;
    value: number; // Must be non-negative
  }>;
}

interface FORCalculationResult {
  forRequirement: number; // Primary result
  annualExpenditure: number;
  adjustedExpenditure: number;
  adjustmentTotal: number;
  
  // Supplementary metrics
  monthlyRunRate: number;
  dailyBurnRate: number;
  coverageDays: number;
  
  // Detailed breakdown
  breakdown?: CostBreakdown;
  subcategoryBreakdown?: Record<string, Record<string, number>>;
  
  // Regulatory metadata
  metadata: {
    calculationDate: Date;
    approach: 'consolidated' | 'granular';
    version: string; // Calculator version (e.g., "2.0")
    methodology: string; // "MiFIDPRU 4.5"
    regulatoryBasis: string; // "25% of prescribed costs"
    adjustmentsApplied: boolean;
    auditTrail: AuditMetadata;
  };
}

// ❌ BAD: Loose typing that could cause regulatory calculation errors
function calculateFOR(data: any): any {
  return { result: data.costs * 0.25 };
}
```

#### Error Handling Standards for Financial Software
```typescript
// ✅ GOOD: Comprehensive error handling with regulatory audit trail
export class CalculationError extends Error {
  constructor(
    message: string,
    public readonly calculationType: string,
    public readonly input: unknown,
    public readonly regulatoryContext: Record<string, unknown> = {},
    public readonly userContext?: UserContext
  ) {
    super(message);
    this.name = 'CalculationError';
    
    // Log for regulatory audit trail
    auditLogger.error('Calculation error occurred', {
      calculationType,
      input,
      regulatoryContext,
      userContext,
      timestamp: new Date().toISOString(),
      regulatoryImpact: this.assessRegulatoryImpact()
    });
  }
  
  private assessRegulatoryImpact(): 'low' | 'medium' | 'high' {
    // Assess potential regulatory impact of the calculation error
    if (this.calculationType === 'MCR' || this.calculationType === 'FOR') {
      return 'high'; // Core capital calculations
    } else if (this.calculationType.startsWith('K_')) {
      return 'medium'; // K-factor calculations
    }
    return 'low';
  }
}

// Usage in calculator functions
try {
  const result = FORCalculator.calculate(input);
} catch (error) {
  if (error instanceof CalculationError) {
    // Handle calculation-specific errors with regulatory context
    throw new TRPCError({
      code: 'BAD_REQUEST',
      message: `FOR calculation failed: ${error.message}`,
      cause: error
    });
  }
  
  // Log unexpected errors for investigation
  regulatoryLogger.critical('Unexpected calculation error', {
    error: error.message,
    stack: error.stack,
    calculationType: 'FOR',
    requiresRegulatoryReview: true
  });
  
  throw error;
}
```

---

## Git Workflow for Financial Software Development

### 1. Branch Strategy for Calculator Platform

#### Branch Naming Convention
```bash
# Feature branches for new calculators or enhancements
feature/for-calculator-v3-enhancements
feature/kfr-sni-intelligence-updates
feature/ktcd-saccr-performance-optimization
feature/risk-velocity-correlation-modeling

# Bug fixes for calculation errors (high priority)
fix/for-calculation-precision-error-q4-costs
fix/kfr-sni-threshold-boundary-conditions
fix/ktcd-netting-set-aggregation-bug

# Regulatory updates (critical priority)
regulatory/mifidpru-4.9-implementation
regulatory/icara-framework-2025-updates
regulatory/fca-ps25-5-compliance-changes

# Calculator-specific improvements
calculator/for-scenario-planning-enhancements
calculator/kfr-coefficient-updates
calculator/ktcd-margin-agreement-types

# Documentation updates
docs/api-specification-v2-update
docs/calculation-methodology-review
docs/regulatory-compliance-guide

# Infrastructure and deployment
infra/vercel-edge-function-optimization
infra/database-performance-calculator-queries
infra/monitoring-regulatory-compliance-metrics
```

#### Branch Lifecycle for Calculator Development
```bash
# 1. Create feature branch from main
git checkout main
git pull origin main
git checkout -b feature/for-calculator-adjustments-module

# 2. Work with AI assistance to implement calculator features
# ... development work following regulatory requirements ...

# 3. Comprehensive testing before commit (critical for financial software)
pnpm test # All tests must pass
pnpm test:regulatory # Regulatory compliance tests
pnpm test:cross-validation # Validate against HTML prototypes
pnpm test:performance # Ensure calculation performance standards
pnpm type-check # TypeScript validation
pnpm lint # Code quality standards

# 4. Commit with detailed regulatory context
git add .
git commit -m "feat(for): implement MiFIDPRU 4.5.3R adjustments module

- Add comprehensive adjustments tracking for one-off items
- Implement adjustment validation per regulatory requirements
- Include detailed audit trail for FCA review
- Support both positive and negative adjustments
- Add automated calculation impact analysis
- Ensure complete data persistence for 7-year retention

Regulatory compliance:
- MiFIDPRU 4.5.3R: One-off items exclusion
- SYSC 4.1.1R: Record keeping requirements
- MIFIDPRU 9.1.1R: Notification obligations

Testing:
- 47 new test cases covering edge conditions
- Cross-validation with HTML prototype: ✓ PASS
- Performance: <50ms for complex adjustments
- Regulatory examples validation: ✓ PASS

Breaking changes: None
Data migration: Automatic"

# 5. Push and create detailed PR
git push origin feature/for-calculator-adjustments-module
```

### 2. Commit Message Standards for Financial Software

#### Enhanced Format for Regulatory Context
```
<type>(<scope>): <subject>

<body>

<regulatory-compliance>
<testing-validation>
<breaking-changes>
<footer>
```

#### Types and Examples
- `feat`: New calculator feature or enhancement
- `fix`: Bug fix in calculation logic  
- `regulatory`: Regulatory compliance update
- `test`: Testing improvements or new test cases
- `docs`: Documentation updates
- `refactor`: Code refactoring without functional changes
- `perf`: Performance improvements for calculations
- `security`: Security enhancements for financial data
- `infra`: Infrastructure and deployment changes

#### Detailed Examples
```bash
# Major calculator enhancement
git commit -m "feat(kfr): implement SNI classification intelligence v2.0

Adds real-time SNI threshold monitoring with predictive analysis:
- Automatic SNI/Non-SNI classification based on MiFIDPRU thresholds
- Real-time proximity warnings when approaching £5M thresholds
- Historical trend analysis for SNI status prediction
- Enhanced visual indicators for threshold monitoring
- Intelligent K-factor activation/deactivation based on classification

Regulatory compliance:
- MiFIDPRU 4.1.1R: Small and non-interconnected definition
- MiFIDPRU 4.6.1R: K-factor requirement application
- MiFIDPRU 9.1.1R: Notification requirements for threshold breaches

Testing validation:
- 127 test scenarios covering boundary conditions
- Cross-validation with existing HTML calculator: ✓ PASS
- Performance testing: <100ms for complex firm profiles
- FCA example validation: All 15 examples pass
- Edge case testing: Threshold boundaries ±£1

Implementation details:
- Added real-time calculation engine with caching
- Implemented WebSocket updates for live threshold monitoring
- Enhanced UI with gradient-based threshold visualization
- Added comprehensive audit logging for regulatory review

Breaking changes: None
Database migration: Adds SNI monitoring tables
Affects: KFR Calculator, Firm Management, Reporting"

# Critical calculation fix
git commit -m "fix(ktcd): correct SA-CCR alpha factor application in EAD calculation

Critical fix for Exposure at Default calculation in SA-CCR methodology:
- Corrected alpha factor application (α = 1.4) per CRR Article 274
- Fixed calculation order: EAD = α × (RC + PFE) not (α × RC) + PFE
- Impacted all K-TCD calculations with multiple asset classes

Regulatory impact:
- Affects all historical K-TCD calculations since v1.0 deployment
- Requires recalculation of existing client MCR determinations
- May impact regulatory capital adequacy assessments

Root cause analysis:
- Misinterpretation of CRR Article 274(1) formula bracketing
- Code review missed calculation precedence error
- Insufficient test coverage for multi-asset class portfolios

Validation:
- Tested against 23 regulatory examples from CRR
- Cross-validated with industry SA-CCR implementations
- Performance impact: Negligible (<5ms increase)
- Backward compatibility: Maintained for API consumers

Client impact assessment:
- Estimated impact: ±2-8% of K-TCD values depending on portfolio
- Requires client notification per regulatory disclosure requirements
- Migration script provided for historical data correction

Breaking changes: None (API compatible)
Data migration: Historical calculation recomputation required
Regulatory notification: FCA notification recommended"

# Regulatory update
git commit -m "regulatory(platform): implement MiFIDPRU 4.8 amendments effective 2025-08-01

Comprehensive implementation of FCA Policy Statement PS25/4:
- Updated prescribed cost categories per MiFIDPRU 4.8.1R
- Modified K-NPR risk weights for illiquid equity positions (8%→12%)
- Enhanced ICARA documentation requirements per MiFIDPRU 7.7.1R
- Added new reporting thresholds for concentration risk (K-CON)

Affected calculators:
- FOR Calculator: New cost subcategories for ESG compliance costs
- K-NPR Calculator: Updated risk weights and maturity factors
- Risk Assessment: Enhanced documentation requirements
- Reporting: New regulatory template formats

Implementation timeline:
- Effective date: 2025-08-01 (regulatory mandate)
- Backward compatibility: Maintained for calculations before effective date
- Data migration: Automatic for new calculations, optional for historical

Regulatory references:
- FCA Policy Statement PS25/4 (June 2025)
- MiFIDPRU 4.8.1R: Prescribed costs definition
- MiFIDPRU 4.10.2R: K-NPR risk weights
- MiFIDPRU 7.7.1R: ICARA documentation

Testing validation:
- All regulatory examples updated and tested
- Industry benchmarking completed
- Cross-validation with updated FCA guidance
- Performance impact assessment: <5% increase

Client communication:
- Automatic notification of regulatory changes
- Updated calculation methodologies in user documentation
- Training materials updated for new requirements

Breaking changes: None (versioned implementation)
Migration: Automatic post-effective date"
```

### 3. Pull Request Process for Financial Software

#### Enhanced PR Template for Calculator Platform
```markdown
## Calculator Enhancement Summary
Brief description of calculation changes and regulatory impact.

## Type of Change
- [ ] New calculator/feature implementation
- [ ] Calculation logic bug fix
- [ ] Regulatory compliance update
- [ ] Performance optimization
- [ ] Security enhancement
- [ ] Documentation update

## Calculator Impact Assessment
- [ ] FOR Calculator (specify impact level)
- [ ] KFR Calculator (specify impact level) 
- [ ] K-TCD Calculator (specify impact level)
- [ ] K-NPR Calculator (specify impact level)
- [ ] K-CON Calculator (specify impact level)
- [ ] Risk Assessment Calculator (specify impact level)
- [ ] MCR Aggregation (specify impact level)

## Regulatory Compliance Review
- [ ] No regulatory impact
- [ ] Updates existing regulatory calculation methodology
- [ ] Implements new regulatory requirement
- [ ] Changes calculation audit trail or reporting
- [ ] Requires client notification of methodology changes

### Regulatory References
List all applicable regulatory references (MiFIDPRU articles, FCA guidance, etc.)

### Calculation Accuracy Validation
- [ ] All existing calculation tests pass
- [ ] New tests added for enhanced functionality
- [ ] Cross-validation with HTML prototypes completed
- [ ] Edge cases and boundary conditions tested
- [ ] Performance benchmarks met (<100ms for standard calculations)

### Regulatory Testing Validation
- [ ] Calculation methodology reviewed against regulations
- [ ] Test cases include regulatory compliance scenarios
- [ ] FCA example calculations validated (where applicable)
- [ ] Industry benchmarking completed (where applicable)
- [ ] Audit trail maintained for all calculation changes

### Client Impact Assessment
- [ ] Backward compatibility maintained
- [ ] Breaking changes documented and justified
- [ ] Data migration strategy provided (if required)
- [ ] Client notification requirements assessed
- [ ] User documentation updated

### Security and Data Protection
- [ ] Financial data encryption maintained
- [ ] Access controls preserved
- [ ] Audit logging enhanced/maintained
- [ ] GDPR compliance maintained
- [ ] Regulatory data retention requirements met

### Testing Checklist
- [ ] Unit tests: 95%+ coverage for new code
- [ ] Integration tests: API endpoints validated
- [ ] Performance tests: Calculation benchmarks met
- [ ] Security tests: No new vulnerabilities introduced
- [ ] Regulatory tests: Compliance scenarios validated
- [ ] Cross-validation tests: HTML prototype parity maintained

### Documentation Requirements
- [ ] Code properly commented with regulatory references
- [ ] API documentation updated (if applicable)
- [ ] User guide updates completed
- [ ] Regulatory methodology documentation updated
- [ ] Migration guide provided (if required)

## Deployment Considerations
- [ ] Database migration required
- [ ] Configuration changes needed
- [ ] Client notification timeline established
- [ ] Rollback procedure documented
- [ ] Monitoring alerts configured

## Reviewer Assignment
- [ ] Technical review: Code quality and architecture
- [ ] Regulatory review: Compliance and calculation accuracy
- [ ] Security review: Data protection and access controls
- [ ] Documentation review: Completeness and accuracy
```

---

## AI-Assisted Development Guidelines

### 1. Effective AI Collaboration for Financial Software

#### Advanced Prompt Engineering for Calculator Development
```markdown
# Excellent AI prompts for financial regulatory software

"Create a TypeScript implementation of the K-NPR (Net Position Risk) calculator according to MiFIDPRU 4.10. Requirements:

REGULATORY CONTEXT:
- Implement full position risk calculation per MiFIDPRU 4.10.1-4.10.15
- Support equity positions (8% risk weight for liquid, 12% for illiquid)
- Support debt positions with maturity-based risk weights
- Handle both long and short positions with proper netting
- Include currency risk calculations for non-GBP positions

TECHNICAL REQUIREMENTS:
- Complete TypeScript interfaces with Zod validation
- Decimal.js for all financial calculations (no floating point errors)
- Comprehensive error handling with regulatory context
- Performance target: <200ms for portfolios up to 1000 positions
- Audit trail integration for all calculations

INTEGRATION REQUIREMENTS:
- Must integrate with existing KFR Calculator 2.0
- Support real-time updates via WebSocket
- Export capability to regulatory reporting formats
- Cross-validation with HTML prototype mandatory

TESTING REQUIREMENTS:
- Include comprehensive test suite with FCA examples
- Edge case testing for boundary conditions
- Performance benchmarking
- Cross-validation test data extraction from HTML

Please include complete JSDoc comments with regulatory references, example usage, and detailed explanation of calculation methodology."

# Poor AI prompts that won't produce quality results
"Make a position risk calculator"
"Calculate K-NPR for some positions"
"Fix the calculation bug"
```

#### Iterative Development Pattern for Complex Calculators
```bash
# 1. Start with comprehensive regulatory analysis
"Analyze MiFIDPRU 4.12 requirements for K-TCD (SA-CCR) calculation. Break down into implementable components:

- Replacement Cost (RC) calculation methodology
- Potential Future Exposure (PFE) calculation by asset class
- Exposure at Default (EAD) formula with alpha factor
- Netting set aggregation rules
- Asset class supervisory factors and correlations
- Margin agreement impact on RC calculation
- Multi-currency portfolio handling

For each component, specify:
- Input data requirements and validation rules
- Calculation steps with regulatory references
- Output format and precision requirements
- Error conditions and handling requirements"

# 2. Design comprehensive data structures
"Based on the SA-CCR analysis, design TypeScript interfaces for the K-TCD calculator:

- Complete type safety for all calculation inputs
- Support for multiple netting sets and counterparties
- Margin agreement types (None, VM, VM+IM) with proper validation
- Asset class categorization with specific product types
- Comprehensive error types for calculation failures
- Result structures with detailed breakdown for audit

Include Zod schemas for runtime validation and comprehensive JSDoc with regulatory references."

# 3. Implement core calculation logic with full transparency
"Implement the SA-CCR calculation engine with complete transparency:

- Step-by-step calculation following CRR Article 274-280
- Detailed logging for regulatory audit trail
- Intermediate result capture for debugging and validation
- Performance optimization while maintaining calculation accuracy
- Error handling with regulatory context and recovery suggestions

Ensure the implementation can be easily validated against regulatory examples and supports the industry-first web-based SA-CCR claim."

# 4. Add comprehensive testing strategy
"Create comprehensive test suite for K-TCD SA-CCR calculator:

- Regulatory compliance test cases from CRR examples
- Edge case validation for boundary conditions
- Performance testing for large portfolios
- Cross-validation with any existing implementations
- Integration testing with KFR calculator
- Error path testing with recovery validation

Include test data generation utilities and comparison tools for validating against regulatory benchmarks."

# 5. Integration and documentation
"Complete K-TCD calculator integration:

- tRPC API endpoints with proper authentication
- Real-time calculation updates via WebSocket
- Integration with KFR calculator for automatic K-factor updates
- Export functionality for regulatory reporting
- User interface components for calculation input and results
- Comprehensive API documentation with regulatory context
- User guide with calculation methodology explanation

Ensure all integration maintains the audit trail and regulatory compliance requirements."
```

### 2. Code Review with AI for Financial Software

#### AI-Assisted Review Checklist for Calculator Platform
```typescript
/**
 * AI Review Prompt Template for Financial Software:
 * 
 * "Review this TypeScript code for financial regulatory calculation platform:
 * 
 * 1. REGULATORY COMPLIANCE REVIEW:
 *    - Verify calculation methodology matches MiFIDPRU/ICARA requirements
 *    - Check for proper regulatory references in code comments
 *    - Ensure complete audit trail implementation
 *    - Validate error handling includes regulatory context
 *    - Confirm data retention meets 7-year requirement
 * 
 * 2. FINANCIAL CALCULATION ACCURACY:
 *    - Verify use of Decimal.js for all financial mathematics
 *    - Check for proper rounding to penny accuracy
 *    - Validate currency handling and conversion logic
 *    - Ensure calculation precision maintained throughout
 *    - Check for potential floating-point errors
 * 
 * 3. TYPE SAFETY AND VALIDATION:
 *    - Validate TypeScript interfaces are comprehensive
 *    - Check for proper Zod schema validation
 *    - Ensure no 'any' types in calculation logic
 *    - Verify input validation covers all edge cases
 *    - Confirm output types match regulatory requirements
 * 
 * 4. ERROR HANDLING AND SECURITY:
 *    - Verify all calculation error paths are handled
 *    - Check error messages provide debugging context
 *    - Ensure sensitive financial data is properly protected
 *    - Validate audit logging captures sufficient detail
 *    - Confirm access controls are properly implemented
 * 
 * 5. PERFORMANCE AND SCALABILITY:
 *    - Identify potential performance bottlenecks
 *    - Suggest optimizations for large calculation datasets
 *    - Verify caching strategies are appropriate
 *    - Check memory usage for complex calculations
 *    - Ensure calculations meet <200ms performance targets
 * 
 * 6. TESTING AND VALIDATION:
 *    - Identify missing test scenarios
 *    - Suggest regulatory compliance test cases
 *    - Recommend edge cases for validation
 *    - Check cross-validation test completeness
 *    - Verify performance test coverage
 * 
 * 7. DOCUMENTATION AND MAINTAINABILITY:
 *    - Check JSDoc completeness and accuracy
 *    - Verify regulatory references are current and accurate
 *    - Suggest improvements for code clarity
 *    - Recommend additional documentation areas
 *    - Ensure calculation methodology is well-documented
 * 
 * Code to review:
 * [INSERT CALCULATOR CODE HERE]
 * 
 * Focus particularly on:
 * - Calculation accuracy and regulatory compliance
 * - Error handling and audit trail completeness
 * - Performance implications for institutional clients
 * - Integration compatibility with existing calculator suite
 */
```

### 3. Documentation Standards for Financial Software

#### Comprehensive JSDoc for Financial Calculations
```typescript
/**
 * Calculate K-TCD (Trading Counterparty Default) requirement using SA-CCR methodology
 * 
 * Implements the Standardised Approach for Counterparty Credit Risk (SA-CCR) per
 * CRR Articles 274-280, as required by MiFIDPRU 4.12 for investment firms.
 * 
 * This is an industry-first web-based implementation of the complete SA-CCR framework,
 * traditionally requiring specialist consultants or complex spreadsheet models.
 * 
 * @param input - Complete K-TCD calculation input with netting sets and transactions
 * @param input.nettingSets - Array of counterparty netting sets with margin agreements
 * @param input.nettingSets[].transactions - Individual derivative transactions
 * @param input.nettingSets[].marginType - Margin agreement type affecting RC calculation
 * 
 * @returns Complete K-TCD calculation result with detailed SA-CCR breakdown
 * 
 * @throws {CalculationError} When input validation fails or SA-CCR cannot be calculated
 * @throws {RegulatoryComplianceError} When calculation violates regulatory constraints
 * 
 * @example
 * ```typescript
 * const ktcdInput: KTCDInput = {
 *   nettingSets: [
 *     {
 *       id: 'NS001',
 *       counterparty: 'Major Bank Ltd',
 *       counterpartyType: 'financial',
 *       riskWeight: 0.02, // 2% for bank counterparty
 *       marginType: 'vmim', // Both VM and IM posted
 *       collateralHeld: 150000,
 *       collateralPosted: 80000,
 *       threshold: 50000,
 *       transactions: [
 *         {
 *           id: 'TXN001',
 *           assetClass: 'ir',
 *           productType: 'swap',
 *           notional: 10000000,
 *           marketValue: 125000,
 *           maturity: 3.5,
 *           position: 'long'
 *         }
 *         // ... additional transactions
 *       ]
 *     }
 *   ]
 * };
 * 
 * const result = calculateKTCD(ktcdInput);
 * console.log(`K-TCD Requirement: £${result.totalKTCD.toLocaleString()}`);
 * console.log(`Driving netting set: ${result.nettingSetResults[0].nettingSetId}`);
 * ```
 * 
 * @regulatory
 * - CRR Article 274: SA-CCR methodology definition
 * - CRR Article 275: Replacement cost calculation
 * - CRR Article 276: Potential future exposure calculation  
 * - CRR Article 277: Asset class supervisory factors
 * - CRR Article 278: Maturity factors and correlations
 * - CRR Article 279: Netting set aggregation rules
 * - CRR Article 280: Add-on calculation methodology
 * - MiFIDPRU 4.12.1R: K-TCD calculation requirement
 * - MiFIDPRU 4.12.2R: Counterparty risk weight application
 * 
 * @auditTrail
 * All SA-CCR calculations are logged with:
 * - Complete input data hash for reproducibility
 * - Intermediate calculation steps for validation
 * - Counterparty risk assessment details
 * - Margin agreement impact analysis
 * - Asset class contribution breakdown
 * - Calculation timestamp and user context
 * - Regulatory methodology version used
 * 
 * @precision
 * All calculations use Decimal.js to avoid floating-point errors.
 * Results are rounded to penny accuracy (2 decimal places) per UK
 * regulatory standards for capital calculations.
 * 
 * @performance
 * Optimized for institutional portfolios:
 * - Target: <500ms for portfolios up to 1000 transactions
 * - Memory efficient netting set processing
 * - Parallel asset class calculations where possible
 * - Intelligent caching of supervisory factors
 * 
 * @industryFirst
 * This implementation represents the first publicly available
 * web-based SA-CCR calculator, traditionally requiring:
 * - Specialist regulatory consultants (£2-3K per calculation)
 * - Complex Excel models prone to formula errors
 * - 2-3 hours manual processing time
 * 
 * Our implementation provides:
 * - Instant calculation results (<1 second)
 * - Complete transparency of methodology
 * - Elimination of manual formula errors
 * - Full audit trail for regulatory review
 * 
 * @version 1.0.0
 * @since 2025-06-01
 * @author AI-Assisted Development (Human: SA-CCR Expertise, AI: Implementation)
 * @lastReviewed 2025-06-27
 * @nextReview 2025-12-01 (or upon regulatory changes)
 */
export function calculateKTCD(input: KTCDInput): KTCDResult {
  // Implementation with full regulatory compliance...
}
```

---

## Testing Guidelines for Financial Software

### 1. Test-Driven Development for Calculator Accuracy

#### Regulatory Test-First Approach
```typescript
// 1. Write regulatory compliance test first using known examples
describe('K-TCD Calculator - CRR Article 274 Compliance', () => {
  test('should calculate SA-CCR EAD exactly per CRR methodology', () => {
    // Use actual regulatory example from CRR technical standards
    const crrExampleInput: KTCDInput = {
      nettingSets: [
        {
          id: 'CRR_EXAMPLE_1',
          counterparty: 'Reference Bank',
          counterpartyType: 'financial',
          riskWeight: 0.02, // 2% per CRR Article 113
          marginType: 'vm', // Variation margin only
          collateralHeld: 0,
          collateralPosted: 0,
          threshold: 0,
          transactions: [
            {
              id: 'IRS_001',
              assetClass: 'ir',
              productType: 'swap',
              notional: 10000000, // €10M notional
              marketValue: 200000, // €200K positive MTM
              maturity: 4, // 4 years
              position: 'long'
            }
          ]
        }
      ]
    };
    
    const result = calculateKTCD(crrExampleInput);
    
    // Validate step-by-step per CRR methodology
    
    // Step 1: Replacement Cost calculation (CRR Article 275)
    // RC = max(V - C, TH - C, 0) where V = MTM, C = net collateral, TH = threshold
    // RC = max(200000 - 0, 0 - 0, 0) = 200000
    expect(result.nettingSetResults[0].replacementCost).toBeCloseTo(200000, 2);
    
    // Step 2: PFE calculation (CRR Article 276)
    // For IR: PFE = max(AddOn - RC, 0.05 × AddOn)
    // AddOn = SF × M × Notional = 0.005 × 1.0 × 10000000 = 50000
    expect(result.nettingSetResults[0].potentialFutureExposure).toBeCloseTo(50000, 2);
    
    // Step 3: EAD calculation
    // EAD = α × (RC + PFE) = 1.4 × (200000 + 50000) = 350000
    expect(result.nettingSetResults[0].exposureAtDefault).toBeCloseTo(350000, 2);
    
    // Step 4: RWA calculation  
    // RWA = EAD × RW = 350000 × 0.02 = 7000
    expect(result.nettingSetResults[0].riskWeightedAssets).toBeCloseTo(7000, 2);
    
    // Step 5: K-TCD calculation
    // K-TCD = RWA + CVA = 7000 + (7000 × 0.015) = 7105
    expect(result.totalKTCD).toBeCloseTo(7105, 2);
    
    // Verify regulatory methodology is documented
    expect(result.metadata.methodology).toBe('SA-CCR');
    expect(result.metadata.regulatoryBasis).toContain('CRR Article 274');
    expect(result.metadata.industryFirst).toBe(true);
  });
});

// 2. Implement calculation to pass regulatory test
export function calculateKTCD(input: KTCDInput): KTCDResult {
  // Implementation follows test requirements exactly...
}

// 3. Add comprehensive edge cases and error scenarios
describe('K-TCD Calculator - Edge Cases and Error Handling', () => {
  test('should handle zero market value positions correctly', () => {
    // Test implementation for zero MTM scenarios
  });
  
  test('should validate counterparty risk weights within CRR bounds', () => {
    // Test implementation for risk weight validation
  });
  
  test('should handle multi-currency portfolios with proper conversion', () => {
    // Test implementation for currency handling
  });
});
```

### 2. Cross-Validation Testing with HTML Prototypes

#### Comprehensive Calculator Validation Framework
```typescript
/**
 * Cross-validation framework ensuring React calculators produce identical
 * results to validated HTML prototypes across all calculator types
 */
describe('Calculator Platform - HTML vs React Cross-Validation', () => {
  
  // FOR Calculator 2.0 validation
  describe('FOR Calculator 2.0 Cross-Validation', () => {
    const forReferenceData = require('../../tests/reference-data/for-2.0-reference.json');
    
    forReferenceData.forEach((testCase: any) => {
      test(`${testCase.id}: ${testCase.description}`, () => {
        // Transform HTML input format to React format
        const reactInput = transformFORInputToReact(testCase.input);
        
        // Calculate using React implementation
        const reactResult = FORCalculator.calculate(reactInput);
        
        // Extract HTML results
        const htmlResult = testCase.htmlResult;
        
        // Validate penny-perfect accuracy
        const forDeviation = Math.abs(reactResult.forRequirement - htmlResult.forValue);
        expect(forDeviation).toBeLessThanOrEqual(0.01);
        
        // Validate total costs match
        const costDeviation = Math.abs(reactResult.annualExpenditure - htmlResult.totalCosts);
        expect(costDeviation).toBeLessThanOrEqual(0.01);
        
        // Validate category breakdowns (for granular approach)
        if (reactInput.approach === 'granular') {
          Object.entries(htmlResult.categoryBreakdown || {}).forEach(([category, expectedValue]) => {
            const actualValue = reactResult.breakdown?.[category] || 0;
            expect(Math.abs(actualValue - (expectedValue as number))).toBeLessThanOrEqual(0.01);
          });
        }
        
        // Log validation success for audit trail
        console.log(`✅ FOR Cross-validation ${testCase.id}:`, {
          html: htmlResult.forValue,
          react: reactResult.forRequirement,
          deviation: forDeviation,
          approach: reactInput.approach,
          status: 'PASS'
        });
      });
    });
  });
  
  // KFR Calculator with SNI Intelligence validation
  describe('KFR Calculator SNI Intelligence Cross-Validation', () => {
    const kfrReferenceData = require('../../tests/reference-data/kfr-sni-reference.json');
    
    kfrReferenceData.forEach((testCase: any) => {
      test(`${testCase.id}: ${testCase.description}`, () => {
        const reactInput = transformKFRInputToReact(testCase.input);
        const reactResult = KFRCalculator.calculate(reactInput);
        const htmlResult = testCase.htmlResult;
        
        // Validate SNI classification matches
        expect(reactResult.sniClassification.isSNI).toBe(htmlResult.sniClassification);
        
        // Validate KFR requirement (should be 0 for SNI firms)
        const kfrDeviation = Math.abs(reactResult.kfrRequirement - htmlResult.kfrValue);
        expect(kfrDeviation).toBeLessThanOrEqual(0.01);
        
        // Validate individual K-factor calculations (even if SNI)
        Object.entries(htmlResult.kFactorBreakdown || {}).forEach(([factor, expectedValue]) => {
          const actualValue = getKFactorValue(reactResult.calculatedKFactors, factor);
          expect(Math.abs(actualValue - (expectedValue as number))).toBeLessThanOrEqual(0.01);
        });
        
        console.log(`✅ KFR Cross-validation ${testCase.id}:`, {
          sniClassification: reactResult.sniClassification.isSNI,
          kfrRequirement: reactResult.kfrRequirement,
          status: 'PASS'
        });
      });
    });
  });
  
  // K-TCD SA-CCR validation (industry-first implementation)
  describe('K-TCD SA-CCR Cross-Validation', () => {
    const ktcdReferenceData = require('../../tests/reference-data/ktcd-saccr-reference.json');
    
    ktcdReferenceData.forEach((testCase: any) => {
      test(`${testCase.id}: ${testCase.description}`, () => {
        const reactInput = transformKTCDInputToReact(testCase.input);
        const reactResult = KTCDCalculator.calculate(reactInput);
        const htmlResult = testCase.htmlResult;
        
        // Validate total K-TCD
        const ktcdDeviation = Math.abs(reactResult.totalKTCD - htmlResult.totalKTCD);
        expect(ktcdDeviation).toBeLessThanOrEqual(0.01);
        
        // Validate SA-CCR components for each netting set
        reactResult.nettingSetResults.forEach((nsResult, index) => {
          const expectedNS = htmlResult.nettingSetResults[index];
          
          // Replacement Cost validation
          expect(Math.abs(nsResult.replacementCost - expectedNS.replacementCost)).toBeLessThanOrEqual(0.01);
          
          // Potential Future Exposure validation
          expect(Math.abs(nsResult.potentialFutureExposure - expectedNS.pfe)).toBeLessThanOrEqual(0.01);
          
          // Exposure at Default validation
          expect(Math.abs(nsResult.exposureAtDefault - expectedNS.ead)).toBeLessThanOrEqual(0.01);
          
          // Risk Weighted Assets validation
          expect(Math.abs(nsResult.riskWeightedAssets - expectedNS.rwa)).toBeLessThanOrEqual(0.01);
        });
        
        console.log(`✅ K-TCD SA-CCR Cross-validation ${testCase.id}:`, {
          totalKTCD: reactResult.totalKTCD,
          nettingSets: reactResult.nettingSetResults.length,
          industryFirst: reactResult.metadata.industryFirst,
          status: 'PASS'
        });
      });
    });
  });
  
  // Risk Assessment with Velocity Factors validation
  describe('Risk Assessment Velocity Factors Cross-Validation', () => {
    const riskReferenceData = require('../../tests/reference-data/risk-velocity-reference.json');
    
    riskReferenceData.forEach((testCase: any) => {
      test(`${testCase.id}: ${testCase.description}`, () => {
        const reactInput = transformRiskInputToReact(testCase.input);
        const reactResult = RiskCalculator.calculate(reactInput);
        const htmlResult = testCase.htmlResult;
        
        // Validate total capital allocation
        const capitalDeviation = Math.abs(reactResult.totalCapitalAllocation - htmlResult.totalCapital);
        expect(capitalDeviation).toBeLessThanOrEqual(0.01);
        
        // Validate individual risk calculations
        reactResult.riskResults.forEach((riskResult, index) => {
          const expectedRisk = htmlResult.riskResults[index];
          
          // Validate velocity-adjusted risk
          expect(Math.abs(riskResult.velocityAdjustedRisk - expectedRisk.velocityAdjusted)).toBeLessThanOrEqual(0.01);
          
          // Validate velocity multiplier
          expect(Math.abs(riskResult.velocityAnalysis.velocityMultiplier - expectedRisk.velocityMultiplier)).toBeLessThanOrEqual(0.001);
        });
        
        // Validate portfolio effects (if correlation modeling applied)
        if (reactInput.correlationMatrix) {
          expect(Math.abs(reactResult.diversificationBenefit - htmlResult.diversificationBenefit)).toBeLessThanOrEqual(0.01);
        }
        
        console.log(`✅ Risk Assessment Cross-validation ${testCase.id}:`, {
          totalCapital: reactResult.totalCapitalAllocation,
          velocityFactorsApplied: true,
          correlationModeling: !!reactInput.correlationMatrix,
          status: 'PASS'
        });
      });
    });
  });
});

// Helper functions for input transformation
function transformFORInputToReact(htmlInput: any): FORInput {
  // Transform HTML localStorage format to React TypeScript interfaces
  if (htmlInput.approach === 'granular') {
    return {
      approach: 'granular',
      firmInfo: htmlInput.firmInfo,
      costCategories: transformCostCategories(htmlInput.costs),
      adjustments: htmlInput.adjustments || []
    };
  } else {
    return {
      approach: 'consolidated',
      firmInfo: htmlInput.firmInfo,
      totalExpenditure: htmlInput.totalExpenditure
    };
  }
}

function transformKFRInputToReact(htmlInput: any): KFRInput {
  // Transform HTML K-factor data to React format with SNI intelligence
  return {
    firmInfo: {
      ...htmlInput.firmInfo,
      totalAssets: htmlInput.sniData.totalAssets,
      balanceSheet: htmlInput.sniData.balanceSheet,
      annualIncome: htmlInput.sniData.annualIncome
    },
    kFactorData: transformKFactorData(htmlInput.kFactors)
  };
}
```

---

## Performance and Quality Standards

### 1. Calculator Performance Benchmarks

#### Regulatory Software Performance Requirements
```typescript
describe('Calculator Performance Standards', () => {
  test('FOR Calculator 2.0 should complete granular calculation within 50ms', async () => {
    const complexFORInput = generateComplexFORInput(); // 6 categories, 24 subcategories
    
    const startTime = performance.now();
    const result = FORCalculator.calculate(complexFORInput);
    const endTime = performance.now();
    
    const duration = endTime - startTime;
    expect(duration).toBeLessThan(50); // Granular calculation performance target
    expect(result.forRequirement).toBeGreaterThan(0);
    expect(result.breakdown).toBeDefined();
  });
  
  test('K-TCD SA-CCR should handle 100+ transactions within 500ms', async () => {
    const largePortfolio = generateLargeKTCDPortfolio(150); // 150 transactions across 10 netting sets
    
    const startTime = performance.now();
    const result = KTCDCalculator.calculate(largePortfolio);
    const endTime = performance.now();
    
    const duration = endTime - startTime;
    expect(duration).toBeLessThan(500); // Industry-first implementation performance
    expect(result.nettingSetResults).toHaveLength(10);
    expect(result.totalKTCD).toBeGreaterThan(0);
    expect(result.metadata.industryFirst).toBe(true);
  });
  
  test('Risk Assessment with velocity factors should complete within 100ms', async () => {
    const complexRiskPortfolio = generateComplexRiskPortfolio(50); // 50 risks with correlations
    
    const startTime = performance.now();
    const result = RiskCalculator.calculatePortfolioCapital(complexRiskPortfolio);
    const endTime = performance.now();
    
    const duration = endTime - startTime;
    expect(duration).toBeLessThan(100);
    expect(result.portfolioCapital).toBeDefined();
    expect(result.diversificationBenefit).toBeGreaterThan(0);
  });
  
  test('Concurrent calculations should maintain performance', async () => {
    // Test concurrent calculation performance (institutional usage pattern)
    const promises = Array.from({ length: 10 }, () => Promise.all([
      FORCalculator.calculate(standardFORInput),
      KFRCalculator.calculate(standardKFRInput),
      RiskCalculator.calculate(standardRiskInput)
    ]));
    
    const startTime = performance.now();
    const results = await Promise.all(promises);
    const endTime = performance.now();
    
    expect(results).toHaveLength(10);
    expect(endTime - startTime).toBeLessThan(2000); // 10 concurrent calculation sets in <2s
  });
});
```

### 2. Memory Management for Financial Calculations

#### Memory Leak Prevention
```typescript
describe('Memory Management - Financial Calculations', () => {
  test('Repeated calculations should not leak memory', () => {
    const initialMemory = process.memoryUsage().heapUsed;
    
    // Run 1000 calculations to test for memory leaks
    for (let i = 0; i < 1000; i++) {
      const result = FORCalculator.calculate(standardFORInput);
      
      // Force garbage collection every 100 iterations
      if (i % 100 === 0 && global.gc) {
        global.gc();
      }
    }
    
    const finalMemory = process.memoryUsage().heapUsed;
    const memoryIncrease = finalMemory - initialMemory;
    
    // Memory increase should be minimal for financial calculations
    expect(memoryIncrease).toBeLessThan(10 * 1024 * 1024); // Less than 10MB increase
  });
  
  test('Large calculation datasets should be garbage collected', () => {
    const initialMemory = process.memoryUsage().heapUsed;
    
    // Process large calculation dataset
    const largeDataset = generateLargeCalculationDataset(10000); // 10K records
    const processedResults = [];
    
    for (const dataPoint of largeDataset) {
      const result = FORCalculator.calculate(dataPoint);
      processedResults.push(result.forRequirement);
    }
    
    // Clear references and force garbage collection
    largeDataset.length = 0;
    processedResults.length = 0;
    
    if (global.gc) {
      global.gc();
    }
    
    const finalMemory = process.memoryUsage().heapUsed;
    const memoryIncrease = finalMemory - initialMemory;
    
    // Memory should return close to initial state
    expect(memoryIncrease).toBeLessThan(50 * 1024 * 1024); // Less than 50MB residual
  });
});
```

---

## Release Process for Financial Software

### 1. Version Management for Regulatory Software

#### Semantic Versioning with Regulatory Context
```
MAJOR.MINOR.PATCH-REGULATORY-BUILD

Examples:
1.0.0 - Initial production release (FOR Calculator 2.0, KFR with SNI intelligence)
1.0.1 - Bug fix (K-TCD calculation precision error)
1.1.0 - New feature (Risk Assessment velocity factors)
1.1.0-mifidpru4.8 - Regulatory update for MiFIDPRU 4.8 amendments
1.2.0 - New calculator (K-CMG implementation)
2.0.0 - Breaking change (new MCR aggregation methodology)
2.0.0-icara2025 - Major regulatory framework update
```

#### Release Notes Template for Financial Software
```markdown
# Release v1.2.0-mifidpru4.8

## Executive Summary
Implementation of MiFIDPRU 4.8 amendments effective 2025-08-01, enhancing calculation accuracy and regulatory compliance across the calculator platform.

## Regulatory Changes
- **MiFIDPRU 4.5**: Updated prescribed cost categories for ESG compliance costs
- **MiFIDPRU 4.10**: Modified K-NPR risk weights for illiquid equities (8% → 12%)
- **MiFIDPRU 7.7**: Enhanced ICARA documentation requirements
- **CRR Article 277**: Updated SA-CCR supervisory factors for commodity derivatives

## Calculator Enhancements

### FOR Calculator 2.0
- **New subcategories**: Added ESG compliance costs under regulatory category
- **Enhanced adjustments**: Support for regulatory adjustment tracking per MiFIDPRU 4.5.3R
- **Performance improvement**: 15% faster calculation for complex granular inputs
- **Audit trail enhancement**: Complete adjustment history with regulatory references

### KFR Calculator (SNI Intelligence)
- **Threshold monitoring**: Real-time proximity alerts for SNI classification boundaries
- **Enhanced accuracy**: Improved coefficient application for component-based K-factors
- **Visual indicators**: Enhanced UI for SNI status and threshold analysis
- **Integration**: Seamless updates from supplementary calculator results

### K-TCD Calculator (Industry-First SA-CCR)
- **Margin efficiency**: Enhanced margin agreement impact calculation
- **Performance optimization**: 25% faster processing for large portfolios (100+ transactions)
- **Currency handling**: Improved multi-currency portfolio risk aggregation
- **Regulatory validation**: Updated against latest CRR technical standards

### Risk Assessment (Velocity Factors)
- **Correlation modeling**: Enhanced risk interdependency recognition
- **Velocity calibration**: Industry benchmarking for velocity factor accuracy
- **Portfolio optimization**: Improved diversification benefit calculation
- **Heat map visualization**: Dynamic risk positioning with 5×5 impact/probability grid

## Bug Fixes
- Fixed K-NPR maturity factor calculation for bonds >10 years duration
- Corrected FOR quarterly cost allocation for mid-year firm establishment
- Resolved K-TCD netting set aggregation for cross-currency portfolios
- Fixed risk assessment correlation matrix validation for edge cases

## Performance Improvements
- Overall platform response time improved by 20%
- Calculator API endpoints now average <150ms response time
- Enhanced caching for frequently accessed calculation components
- Optimized database queries for calculation history retrieval

## Security Enhancements
- Enhanced field-level encryption for sensitive calculation data
- Improved audit trail completeness for regulatory review
- Strengthened access controls for calculation export functionality
- Updated data retention policies for 7-year regulatory compliance

## Breaking Changes
None - this release maintains full backward compatibility with existing calculation data and API consumers.

## Migration Guide
**Automatic Migration**: All new calculations will use updated methodologies post-effective date (2025-08-01).

**Historical Data**: Existing calculations remain unchanged unless explicitly recalculated.

**API Compatibility**: All existing API endpoints maintain compatibility with version negotiation.

## Testing and Validation
- **Regulatory Testing**: All calculations validated against updated FCA guidance examples
- **Cross-validation**: 100% accuracy maintained with HTML prototype baseline
- **Performance Testing**: All benchmarks exceeded for institutional usage patterns
- **Security Testing**: Penetration testing completed with no critical vulnerabilities
- **User Acceptance**: Beta testing completed with 5 institutional clients

## Client Impact Assessment
- **Notification Timeline**: Clients notified 30 days prior to effective date
- **Training Materials**: Updated user guides and calculation methodology documentation
- **Support Availability**: Extended support hours during transition period (2025-07-15 to 2025-08-15)

## Regulatory Compliance Confirmation
- **FCA Compliance**: All changes reviewed against MiFIDPRU requirements
- **Audit Trail**: Complete calculation history maintained for regulatory review
- **Documentation**: Updated regulatory methodology documentation available
- **Reporting**: New calculations support latest regulatory reporting templates

## Deployment Information
- **Staged Rollout**: Deployed to production over 48-hour window with zero downtime
- **Rollback Plan**: Immediate rollback capability maintained for 72 hours post-deployment
- **Monitoring**: Enhanced monitoring in place for first 30 days post-deployment

## Support and Documentation
- **User Guide**: Updated at [docs.icara-platform.app/user-guide](https://docs.icara-platform.app/user-guide)
- **API Documentation**: Updated at [docs.icara-platform.app/api](https://docs.icara-platform.app/api)
- **Regulatory Methodology**: Available at [docs.icara-platform.app/regulatory](https://docs.icara-platform.app/regulatory)
- **Support Contact**: support@icara-platform.app (24/7 during transition period)

---
*This release has been validated against regulatory requirements and approved for institutional deployment.*
```

### 2. Pre-Release Validation for Financial Software

#### Comprehensive Release Validation Checklist
```bash
#!/bin/bash
# scripts/release-validation.sh

echo "=== ICARA Calculator Platform Release Validation ==="

# 1. Regulatory Compliance Tests
echo "Running regulatory compliance validation..."
pnpm test:regulatory --verbose
if [ $? -ne 0 ]; then
    echo "❌ Regulatory compliance tests failed"
    exit 1
fi
echo "✅ Regulatory compliance validated"

# 2. Cross-validation with HTML prototypes
echo "Running cross-validation tests..."
pnpm test:cross-validation --verbose
if [ $? -ne 0 ]; then
    echo "❌ Cross-validation tests failed"
    exit 1
fi
echo "✅ Cross-validation completed successfully"

# 3. Calculator performance benchmarks
echo "Running performance benchmarks..."
pnpm test:performance --verbose
if [ $? -ne 0 ]; then
    echo "❌ Performance benchmarks failed"
    exit 1
fi
echo "✅ Performance benchmarks passed"

# 4. Security vulnerability scan
echo "Running security audit..."
pnpm audit --audit-level moderate
if [ $? -ne 0 ]; then
    echo "⚠️  Security vulnerabilities detected"
    pnpm audit --audit-level high
    if [ $? -ne 0 ]; then
        echo "❌ High-severity vulnerabilities found"
        exit 1
    fi
fi
echo "✅ Security audit passed"

# 5. Database migration validation
echo "Validating database migrations..."
pnpm prisma migrate diff --exit-code
if [ $? -ne 0 ]; then
    echo "⚠️  Database schema changes detected"
    echo "Please ensure migrations are properly tested"
fi

# 6. Build verification across environments
echo "Verifying production build..."
NODE_ENV=production pnpm build
if [ $? -ne 0 ]; then
    echo "❌ Production build failed"
    exit 1
fi
echo "✅ Production build verified"

# 7. API endpoint validation
echo "Testing API endpoints..."
pnpm test:api-integration
if [ $? -ne 0 ]; then
    echo "❌ API integration tests failed"
    exit 1
fi
echo "✅ API endpoints validated"

# 8. Calculator accuracy validation
echo "Running calculator accuracy tests..."
pnpm test:calculator-accuracy --verbose
if [ $? -ne 0 ]; then
    echo "❌ Calculator accuracy tests failed"
    exit 1
fi
echo "✅ Calculator accuracy validated"

# 9. Regulatory methodology validation
echo "Validating regulatory methodologies..."
node scripts/validate-regulatory-references.js
if [ $? -ne 0 ]; then
    echo "❌ Regulatory reference validation failed"
    exit 1
fi
echo "✅ Regulatory methodologies validated"

# 10. Documentation completeness check
echo "Checking documentation completeness..."
node scripts/check-documentation-completeness.js
if [ $? -ne 0 ]; then
    echo "⚠️  Documentation incomplete"
    echo "Please review documentation requirements"
fi

echo "=== Release validation completed successfully ==="
echo ""
echo "Ready for deployment to production environment"
echo "Next steps:"
echo "1. Tag release: git tag v1.2.0-mifidpru4.8"
echo "2. Deploy to staging: vercel --target staging"
echo "3. Run staging validation"
echo "4. Deploy to production: vercel --prod"
echo "5. Monitor post-deployment metrics"
```

This comprehensive contributing guide ensures that AI-assisted development of your sophisticated calculator platform maintains the highest standards of quality, regulatory compliance, and auditability required for institutional financial services software while leveraging your deep domain expertise effectively.