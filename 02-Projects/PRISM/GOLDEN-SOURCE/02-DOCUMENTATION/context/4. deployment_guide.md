# Deployment Guide

## Overview

This guide provides comprehensive instructions for deploying the ICARA/MiFIDPRU Platform to production environments. The deployment strategy focuses on cloud-native architecture with enterprise-grade security, scalability, and reliability for your sophisticated calculator platform including FOR 2.0, KFR with SNI intelligence, industry-first SA-CCR K-TCD implementation, and advanced risk assessment tools.

**Primary Platform**: Vercel (Recommended for Next.js)  
**Alternative Platform**: AWS ECS + ALB  
**Database**: Supabase PostgreSQL or AWS RDS  
**CDN**: CloudFlare  
**Monitoring**: Datadog + Sentry  
**Target**: Enterprise-grade financial services deployment

---

## Deployment Architecture

### 1. Production Architecture Overview

```
┌─────────────────────────────────────────────────────────┐
│                    CloudFlare CDN                      │
│         (DDoS Protection, WAF, SSL, Regulatory)       │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│                   Vercel Edge Network                   │
│           (Global Deployment, Edge Functions)          │
│              Calculator Platform Hosting               │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────┐
│             ICARA Platform (Next.js 14)                │
│   FOR 2.0 | KFR + SNI | K-TCD SA-CCR | Risk+Velocity  │
│              tRPC APIs | Real-time Updates             │
└─────────────────────────┬───────────────────────────────┘
                          │
    ┌─────────────────────┼─────────────────────┐
    │                     │                     │
┌───▼────┐       ┌───────▼──────┐       ┌─────▼─────┐
│Supabase│       │     Auth0    │       │   Redis   │
│PostgreSQL│     │ (Financial   │       │ (Calc     │
│(Calc Data)│    │  Services)   │       │ Cache)    │
└────────┘       └──────────────┘       └───────────┘
```

### 2. Environment Strategy

```yaml
environments:
  development:
    domain: dev.icara-platform.app
    database: Local PostgreSQL
    auth: Auth0 Dev Tenant
    monitoring: Console logs
    calculators: All development features
    
  staging:
    domain: staging.icara-platform.app
    database: Supabase Staging
    auth: Auth0 Staging Tenant
    monitoring: Datadog + Sentry
    calculators: Production parity testing
    
  production:
    domain: app.icara-platform.app
    database: Supabase Production (Enterprise)
    auth: Auth0 Production Tenant
    monitoring: Full observability stack
    calculators: Validated regulatory versions
```

---

## Vercel Deployment (Recommended)

### 1. Initial Setup

#### Prerequisites
```bash
# Install Vercel CLI
npm install -g vercel@latest

# Login to Vercel
vercel login

# Link project (run from project root)
vercel link
```

#### Project Configuration for Calculator Platform
```bash
# Create vercel.json in project root
cat > vercel.json << 'EOF'
{
  "version": 2,
  "builds": [
    {
      "src": "apps/web/package.json",
      "use": "@vercel/next"
    }
  ],
  "routes": [
    {
      "src": "/api/(.*)",
      "dest": "apps/web/api/$1"
    },
    {
      "src": "/calculator/(.*)",
      "dest": "apps/web/calculator/$1"
    },
    {
      "src": "/(.*)",
      "dest": "apps/web/$1"
    }
  ],
  "functions": {
    "apps/web/app/api/**": {
      "maxDuration": 60
    }
  },
  "regions": ["lhr1", "fra1"],
  "framework": "nextjs",
  "outputDirectory": "apps/web/.next",
  "installCommand": "pnpm install --frozen-lockfile",
  "buildCommand": "cd apps/web && pnpm build",
  "devCommand": "cd apps/web && pnpm dev",
  "env": {
    "CALCULATOR_PLATFORM": "production",
    "REGULATORY_VERSION": "MiFIDPRU_4.8"
  }
}
EOF
```

### 2. Environment Variables Setup

#### Staging Environment
```bash
# Core application variables
vercel env add DATABASE_URL staging
# Enter: postgresql://user:pass@db.staging.supabase.co:5432/postgres

vercel env add NEXTAUTH_URL staging  
# Enter: https://staging.icara-platform.app

vercel env add NEXTAUTH_SECRET staging
# Enter: [Generate strong secret: openssl rand -base64 32]

# Authentication (Auth0 for financial services)
vercel env add AUTH0_SECRET staging
# Enter: [Auth0 staging secret]

vercel env add AUTH0_BASE_URL staging
# Enter: https://staging.icara-platform.app

vercel env add AUTH0_ISSUER_BASE_URL staging
# Enter: https://icara-staging.auth0.com

vercel env add AUTH0_CLIENT_ID staging
# Enter: [Auth0 staging client ID]

vercel env add AUTH0_CLIENT_SECRET staging
# Enter: [Auth0 staging client secret]

# Calculator-specific variables
vercel env add CALCULATION_CACHE_TTL staging
# Enter: 3600

vercel env add REGULATORY_VERSION staging
# Enter: MiFIDPRU_4.8

vercel env add FOR_CALCULATOR_VERSION staging
# Enter: 2.0

vercel env add KFR_SNI_INTELLIGENCE staging
# Enter: enabled

vercel env add KTCD_SACCR_ENABLED staging
# Enter: true

vercel env add RISK_VELOCITY_FACTORS staging
# Enter: enabled

# Infrastructure
vercel env add REDIS_URL staging
# Enter: redis://default:password@redis.staging.com:6379

vercel env add SENTRY_DSN staging
# Enter: [Sentry staging DSN]

vercel env add DATADOG_API_KEY staging
# Enter: [Datadog API key]

# External services
vercel env add OPENAI_API_KEY staging
# Enter: [OpenAI key for AI features]

vercel env add STRIPE_SECRET_KEY staging
# Enter: [Stripe staging key for billing]
```

#### Production Environment
```bash
# Repeat all staging variables for production environment
vercel env add DATABASE_URL production
vercel env add NEXTAUTH_URL production
# ... (repeat all variables for production)

# Additional production-only variables
vercel env add NODE_ENV production
# Enter: production

vercel env add LOG_LEVEL production
# Enter: info

vercel env add ENCRYPTION_KEY production
# Enter: [Strong encryption key for sensitive financial data]

vercel env add WEBHOOK_SECRET production
# Enter: [Webhook verification secret]

vercel env add AUDIT_LOG_RETENTION production
# Enter: 2557 # 7 years in days (regulatory requirement)

vercel env add REGULATORY_REPORTING_ENABLED production
# Enter: true

vercel env add CALCULATION_AUDIT_LEVEL production
# Enter: full
```

### 3. Database Setup

#### Supabase PostgreSQL Setup for Calculator Platform
```bash
# Install Supabase CLI
npm install -g supabase@latest

# Login and initialize project
supabase login
supabase projects create icara-platform --plan pro

# Get database connection details
supabase projects list

# Set up database for calculator platform
supabase db start
```

#### Calculator Platform Database Schema
```sql
-- Enhanced schema for calculator platform
-- Run via Supabase SQL editor or migration

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Create calculator-specific tables
CREATE TABLE firms (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  fca_reference VARCHAR(6) UNIQUE NOT NULL CHECK (fca_reference ~ '^[0-9]{6}$'),
  tier firm_tier DEFAULT 'SNI',
  
  -- SNI classification data
  total_assets DECIMAL(15,2),
  balance_sheet DECIMAL(15,2),
  annual_income DECIMAL(15,2),
  
  -- Business activity flags
  business_type VARCHAR(50),
  holds_client_money BOOLEAN DEFAULT false,
  safeguards_assets BOOLEAN DEFAULT false,
  deals_own_account BOOLEAN DEFAULT false,
  executes_orders BOOLEAN DEFAULT false,
  
  subscription_id UUID,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE calculations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  firm_id UUID NOT NULL REFERENCES firms(id) ON DELETE CASCADE,
  user_id UUID NOT NULL,
  type calculation_type NOT NULL,
  version VARCHAR(20) NOT NULL,
  
  -- Encrypted calculation data
  input JSONB NOT NULL,
  result JSONB NOT NULL,
  metadata JSONB NOT NULL,
  
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for calculator performance
CREATE INDEX idx_calculations_firm_type_created ON calculations(firm_id, type, created_at DESC);
CREATE INDEX idx_calculations_user_created ON calculations(user_id, created_at DESC);
CREATE INDEX idx_calculations_type_created ON calculations(type, created_at DESC);

-- Partitioning for large calculation datasets
CREATE TABLE calculations_current PARTITION OF calculations 
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

CREATE TABLE calculations_archive PARTITION OF calculations 
FOR VALUES FROM ('2020-01-01') TO ('2025-01-01');

-- Row Level Security for multi-tenancy
ALTER TABLE calculations ENABLE ROW LEVEL SECURITY;

CREATE POLICY firm_calculation_isolation ON calculations
  FOR ALL 
  TO authenticated
  USING (firm_id = (SELECT firm_id FROM auth.users() WHERE id = auth.uid()));

-- Audit table for regulatory compliance
CREATE TABLE calculation_audit_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  calculation_id UUID REFERENCES calculations(id),
  action VARCHAR(50) NOT NULL,
  user_id UUID NOT NULL,
  ip_address INET,
  user_agent TEXT,
  changes JSONB,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### Database Migration for Calculator Platform
```bash
# Navigate to database package
cd packages/database

# Generate Prisma client for production
pnpm prisma generate

# Run production migrations
DATABASE_URL="your-production-url" pnpm prisma migrate deploy

# Seed calculator reference data
DATABASE_URL="your-production-url" pnpm prisma db seed
```

### 4. Deployment Process

#### Automated Deployment with Calculator Validation
```yaml
# .github/workflows/deploy-calculator-platform.yml
name: Deploy ICARA Calculator Platform

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/calculators/**'
      - 'packages/database/**'
  pull_request:
    branches: [main]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  calculator-validation:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: icara_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        cache: 'pnpm'
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Generate database client
      run: pnpm db:generate
    
    - name: Run calculator accuracy tests
      run: pnpm test:regulatory
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/icara_test
    
    - name: Cross-validate with HTML prototypes
      run: pnpm test:cross-validation
    
    - name: Performance test calculators
      run: pnpm test:performance
    
    - name: Build calculator platform
      run: pnpm build
      env:
        REGULATORY_VERSION: MiFIDPRU_4.8
        FOR_CALCULATOR_VERSION: 2.0

  deploy:
    needs: calculator-validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Install Vercel CLI
      run: npm install --global vercel@latest
    
    - name: Pull Vercel Environment Information
      run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
    
    - name: Build Calculator Platform
      run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
    
    - name: Deploy to Vercel
      run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
    
    - name: Post-deployment Calculator Validation
      run: |
        # Wait for deployment to be live
        sleep 30
        
        # Run smoke tests on deployed calculators
        curl -f https://app.icara-platform.app/api/health
        curl -f https://app.icara-platform.app/api/calculator/for/health
        curl -f https://app.icara-platform.app/api/calculator/kfr/health
        curl -f https://app.icara-platform.app/api/calculator/k-tcd/health
    
    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        text: 'ICARA Calculator Platform deployed successfully to production'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

#### Manual Deployment Commands
```bash
# Deploy to staging with calculator validation
vercel --target staging
vercel logs [staging-deployment-url] # Monitor for errors

# Run staging validation
pnpm test:staging-validation

# Deploy to production (after staging validation passes)
vercel --prod

# Monitor production deployment
vercel logs [production-deployment-url]
```

### 5. Custom Domain and SSL Setup

#### CloudFlare Configuration for Financial Services
```bash
# 1. Add domain to CloudFlare
# 2. Update nameservers at your registrar
# 3. Configure DNS records for calculator platform:

# A Record for main domain
Type: A
Name: @
Content: 76.76.19.61 (Vercel's IP)
Proxy: Enabled (Orange Cloud)

# CNAME for app subdomain
Type: CNAME
Name: app
Content: icara-platform.app
Proxy: Enabled

# CNAME for calculator-specific subdomains
Type: CNAME
Name: calculators
Content: app.icara-platform.app
Proxy: Enabled

# TXT record for domain verification
Type: TXT
Name: @
Content: "vercel-verification-token"
```

#### Enhanced Security Headers for Financial Platform
```typescript
// next.config.js - Enhanced security for financial services
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  },
  {
    key: 'Content-Security-Policy',
    value: `
      default-src 'self';
      script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.auth0.com https://js.stripe.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
      font-src 'self' https://fonts.gstatic.com;
      img-src 'self' data: https: blob:;
      connect-src 'self' https://api.auth0.com https://api.stripe.com wss: https://*.supabase.co;
      frame-src https://js.stripe.com https://*.auth0.com;
      object-src 'none';
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
    `.replace(/\s{2,}/g, ' ').trim()
  }
];

module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: securityHeaders,
      },
      {
        source: '/api/(.*)',
        headers: [
          ...securityHeaders,
          {
            key: 'Cache-Control',
            value: 'no-store, no-cache, must-revalidate'
          }
        ]
      },
      {
        source: '/calculator/(.*)',
        headers: [
          ...securityHeaders,
          {
            key: 'X-Calculator-Platform',
            value: 'ICARA-MiFIDPRU'
          }
        ]
      }
    ];
  },
};
```

#### Vercel Domain Configuration
```bash
# Add custom domain in Vercel dashboard or via CLI
vercel domains add app.icara-platform.app --scope=icara-platform

# Configure domain for calculator platform
vercel domains add calculators.icara-platform.app --scope=icara-platform

# Set up wildcard certificate for subdomains
vercel certs add *.icara-platform.app
```

---

## Alternative AWS Deployment

### 1. Infrastructure as Code (Terraform)

#### Complete AWS Infrastructure for Calculator Platform
```hcl
# infrastructure/main.tf
terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
  
  backend "s3" {
    bucket = "icara-platform-terraform-state"
    key    = "production/terraform.tfstate"
    region = "eu-west-2"
    
    dynamodb_table = "icara-terraform-locks"
    encrypt        = true
  }
}

provider "aws" {
  region = "eu-west-2"
  
  default_tags {
    tags = {
      Project     = "ICARA-Platform"
      Environment = "production"
      Platform    = "Calculator-Suite"
    }
  }
}

# VPC and Networking
resource "aws_vpc" "main" {
  cidr_block           = "10.0.0.0/16"
  enable_dns_hostnames = true
  enable_dns_support   = true
  
  tags = {
    Name = "icara-platform-vpc"
  }
}

# Private subnets for calculator services
resource "aws_subnet" "private" {
  count             = 3
  vpc_id            = aws_vpc.main.id
  cidr_block        = "10.0.${count.index + 1}.0/24"
  availability_zone = data.aws_availability_zones.available.names[count.index]
  
  tags = {
    Name = "icara-platform-private-${count.index + 1}"
    Type = "Private"
  }
}

# Public subnets for load balancers
resource "aws_subnet" "public" {
  count                   = 3
  vpc_id                  = aws_vpc.main.id
  cidr_block              = "10.0.${count.index + 10}.0/24"
  availability_zone       = data.aws_availability_zones.available.names[count.index]
  map_public_ip_on_launch = true
  
  tags = {
    Name = "icara-platform-public-${count.index + 1}"
    Type = "Public"
  }
}

# Internet Gateway
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id
  
  tags = {
    Name = "icara-platform-igw"
  }
}

# NAT Gateways for private subnet internet access
resource "aws_eip" "nat" {
  count  = 3
  domain = "vpc"
  
  depends_on = [aws_internet_gateway.main]
  
  tags = {
    Name = "icara-platform-nat-eip-${count.index + 1}"
  }
}

resource "aws_nat_gateway" "main" {
  count         = 3
  allocation_id = aws_eip.nat[count.index].id
  subnet_id     = aws_subnet.public[count.index].id
  
  depends_on = [aws_internet_gateway.main]
  
  tags = {
    Name = "icara-platform-nat-${count.index + 1}"
  }
}

# Route tables
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id
  
  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }
  
  tags = {
    Name = "icara-platform-public-rt"
  }
}

resource "aws_route_table" "private" {
  count  = 3
  vpc_id = aws_vpc.main.id
  
  route {
    cidr_block = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main[count.index].id
  }
  
  tags = {
    Name = "icara-platform-private-rt-${count.index + 1}"
  }
}

# ECS Cluster for calculator platform
resource "aws_ecs_cluster" "main" {
  name = "icara-platform"
  
  setting {
    name  = "containerInsights"
    value = "enabled"
  }
  
  capacity_providers = ["FARGATE", "FARGATE_SPOT"]
  
  default_capacity_provider_strategy {
    capacity_provider = "FARGATE"
    weight           = 1
  }
  
  tags = {
    Name = "icara-platform-cluster"
  }
}

# Application Load Balancer
resource "aws_lb" "main" {
  name               = "icara-platform-alb"
  internal           = false
  load_balancer_type = "application"
  security_groups    = [aws_security_group.alb.id]
  subnets           = aws_subnet.public[*].id
  
  enable_deletion_protection = true
  enable_http2              = true
  
  access_logs {
    bucket  = aws_s3_bucket.alb_logs.bucket
    prefix  = "calculator-platform"
    enabled = true
  }
  
  tags = {
    Name = "icara-platform-alb"
  }
}

# RDS PostgreSQL for calculator data
resource "aws_db_subnet_group" "main" {
  name       = "icara-platform-db-subnet-group"
  subnet_ids = aws_subnet.private[*].id
  
  tags = {
    Name = "icara-platform-db-subnet-group"
  }
}

resource "aws_db_instance" "postgres" {
  identifier = "icara-platform-db"
  
  engine         = "postgres"
  engine_version = "15.4"
  instance_class = "db.r6g.xlarge" # High performance for calculations
  
  allocated_storage     = 500
  max_allocated_storage = 2000
  storage_type         = "gp3"
  storage_encrypted    = true
  kms_key_id          = aws_kms_key.rds.arn
  
  db_name  = "icara_production"
  username = "icara_admin"
  password = var.db_password
  
  vpc_security_group_ids = [aws_security_group.rds.id]
  db_subnet_group_name   = aws_db_subnet_group.main.name
  
  backup_retention_period = 30
  backup_window          = "03:00-04:00"
  maintenance_window     = "sun:04:00-sun:05:00"
  
  performance_insights_enabled = true
  monitoring_interval         = 60
  monitoring_role_arn        = aws_iam_role.rds_monitoring.arn
  
  skip_final_snapshot = false
  final_snapshot_identifier = "icara-platform-final-snapshot-${formatdate("YYYY-MM-DD-hhmm", timestamp())}"
  
  # Enable point-in-time recovery
  copy_tags_to_snapshot = true
  
  tags = {
    Name = "icara-platform-db"
    Purpose = "calculator-data"
  }
}

# ElastiCache Redis for calculation caching
resource "aws_elasticache_subnet_group" "main" {
  name       = "icara-platform-cache-subnet"
  subnet_ids = aws_subnet.private[*].id
}

resource "aws_elasticache_replication_group" "redis" {
  replication_group_id         = "icara-platform-redis"
  description                  = "Redis cluster for calculator caching"
  
  node_type                    = "cache.r6g.large"
  port                        = 6379
  parameter_group_name        = aws_elasticache_parameter_group.redis.name
  
  num_cache_clusters          = 3
  automatic_failover_enabled  = true
  multi_az_enabled           = true
  
  subnet_group_name          = aws_elasticache_subnet_group.main.name
  security_group_ids         = [aws_security_group.redis.id]
  
  at_rest_encryption_enabled = true
  transit_encryption_enabled = true
  auth_token                = var.redis_auth_token
  
  log_delivery_configuration {
    destination      = aws_cloudwatch_log_group.redis.name
    destination_type = "cloudwatch-logs"
    log_format      = "text"
    log_type        = "slow-log"
  }
  
  tags = {
    Name = "icara-platform-redis"
    Purpose = "calculation-cache"
  }
}

# KMS keys for encryption
resource "aws_kms_key" "rds" {
  description             = "KMS key for RDS encryption"
  deletion_window_in_days = 7
  enable_key_rotation    = true
  
  tags = {
    Name = "icara-platform-rds-key"
  }
}

resource "aws_kms_key" "s3" {
  description             = "KMS key for S3 encryption"
  deletion_window_in_days = 7
  enable_key_rotation    = true
  
  tags = {
    Name = "icara-platform-s3-key"
  }
}

# S3 bucket for calculator exports and reports
resource "aws_s3_bucket" "calculator_exports" {
  bucket = "icara-platform-calculator-exports"
  
  tags = {
    Name = "calculator-exports"
    Purpose = "calculator-reports"
  }
}

resource "aws_s3_bucket_encryption_configuration" "calculator_exports" {
  bucket = aws_s3_bucket.calculator_exports.id
  
  rule {
    apply_server_side_encryption_by_default {
      kms_master_key_id = aws_kms_key.s3.arn
      sse_algorithm     = "aws:kms"
    }
    bucket_key_enabled = true
  }
}

resource "aws_s3_bucket_versioning" "calculator_exports" {
  bucket = aws_s3_bucket.calculator_exports.id
  
  versioning_configuration {
    status = "Enabled"
  }
}

resource "aws_s3_bucket_lifecycle_configuration" "calculator_exports" {
  bucket = aws_s3_bucket.calculator_exports.id
  
  rule {
    id     = "calculator_reports_lifecycle"
    status = "Enabled"
    
    expiration {
      days = 2557 # 7 years (regulatory requirement)
    }
    
    noncurrent_version_expiration {
      noncurrent_days = 90
    }
  }
}

# Security Groups
resource "aws_security_group" "alb" {
  name_prefix = "icara-platform-alb-"
  vpc_id      = aws_vpc.main.id
  
  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  tags = {
    Name = "icara-platform-alb-sg"
  }
}

resource "aws_security_group" "ecs_tasks" {
  name_prefix = "icara-platform-ecs-"
  vpc_id      = aws_vpc.main.id
  
  ingress {
    from_port       = 3000
    to_port         = 3000
    protocol        = "tcp"
    security_groups = [aws_security_group.alb.id]
  }
  
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  tags = {
    Name = "icara-platform-ecs-sg"
  }
}

resource "aws_security_group" "rds" {
  name_prefix = "icara-platform-rds-"
  vpc_id      = aws_vpc.main.id
  
  ingress {
    from_port       = 5432
    to_port         = 5432
    protocol        = "tcp"
    security_groups = [aws_security_group.ecs_tasks.id]
  }
  
  tags = {
    Name = "icara-platform-rds-sg"
  }
}

resource "aws_security_group" "redis" {
  name_prefix = "icara-platform-redis-"
  vpc_id      = aws_vpc.main.id
  
  ingress {
    from_port       = 6379
    to_port         = 6379
    protocol        = "tcp"
    security_groups = [aws_security_group.ecs_tasks.id]
  }
  
  tags = {
    Name = "icara-platform-redis-sg"
  }
}
```

### 2. ECS Task Definition for Calculator Platform

#### Optimized Container Configuration
```json
{
  "family": "icara-calculator-platform",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "2048",
  "memory": "4096",
  "executionRoleArn": "arn:aws:iam::ACCOUNT:role/ecsTaskExecutionRole",
  "taskRoleArn": "arn:aws:iam::ACCOUNT:role/ecsTaskRole",
  "containerDefinitions": [
    {
      "name": "calculator-platform",
      "image": "ACCOUNT.dkr.ecr.eu-west-2.amazonaws.com/icara-platform:latest",
      "portMappings": [
        {
          "containerPort": 3000,
          "protocol": "tcp"
        }
      ],
      "essential": true,
      "environment": [
        {
          "name": "NODE_ENV",
          "value": "production"
        },
        {
          "name": "CALCULATOR_PLATFORM",
          "value": "production"
        },
        {
          "name": "REGULATORY_VERSION",
          "value": "MiFIDPRU_4.8"
        },
        {
          "name": "FOR_CALCULATOR_VERSION", 
          "value": "2.0"
        },
        {
          "name": "KFR_SNI_INTELLIGENCE",
          "value": "enabled"
        },
        {
          "name": "KTCD_SACCR_ENABLED",
          "value": "true"
        }
      ],
      "secrets": [
        {
          "name": "DATABASE_URL",
          "valueFrom": "arn:aws:ssm:eu-west-2:ACCOUNT:parameter/icara/database-url"
        },
        {
          "name": "NEXTAUTH_SECRET",
          "valueFrom": "arn:aws:ssm:eu-west-2:ACCOUNT:parameter/icara/nextauth-secret"
        },
        {
          "name": "AUTH0_CLIENT_SECRET",
          "valueFrom": "arn:aws:ssm:eu-west-2:ACCOUNT:parameter/icara/auth0-client-secret"
        },
        {
          "name": "REDIS_URL",
          "valueFrom": "arn:aws:ssm:eu-west-2:ACCOUNT:parameter/icara/redis-url"
        },
        {
          "name": "ENCRYPTION_KEY",
          "valueFrom": "arn:aws:ssm:eu-west-2:ACCOUNT:parameter/icara/encryption-key"
        }
      ],
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/icara-calculator-platform",
          "awslogs-region": "eu-west-2",
          "awslogs-stream-prefix": "ecs"
        }
      },
      "healthCheck": {
        "command": [
          "CMD-SHELL",
          "curl -f http://localhost:3000/api/health/calculators || exit 1"
        ],
        "interval": 30,
        "timeout": 10,
        "retries": 3,
        "startPeriod": 60
      },
      "stopTimeout": 30
    }
  ]
}
```

### 3. Container Setup for Calculator Platform

#### Optimized Dockerfile
```dockerfile
# Multi-stage Dockerfile optimized for calculator platform
FROM node:20-alpine AS base

# Install dependencies only when needed
FROM base AS deps
RUN apk add --no-cache libc6-compat python3 make g++
WORKDIR /app

# Install dependencies based on pnpm
COPY package.json pnpm-lock.yaml* ./
COPY apps/web/package.json ./apps/web/
COPY packages/calculators/package.json ./packages/calculators/
COPY packages/database/package.json ./packages/database/

RUN corepack enable pnpm && pnpm i --frozen-lockfile --production

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Set build-time environment variables for calculator platform
ENV CALCULATOR_PLATFORM=production
ENV REGULATORY_VERSION=MiFIDPRU_4.8
ENV FOR_CALCULATOR_VERSION=2.0
ENV NEXT_TELEMETRY_DISABLED=1

# Generate Prisma client
RUN cd packages/database && npx prisma generate

# Build calculator platform
RUN cd apps/web && pnpm build

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV CALCULATOR_PLATFORM=production
ENV NEXT_TELEMETRY_DISABLED=1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy built application
COPY --from=builder /app/apps/web/public ./public

# Set the correct permission for prerender cache
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Automatically leverage output traces to reduce image size
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Health check for calculator platform
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:3000/api/health/calculators || exit 1

CMD ["node", "server.js"]
```

---

## Security Configuration

### 1. Enhanced Security for Financial Services

#### Secrets Management with AWS Systems Manager
```bash
# Store calculator platform secrets in AWS SSM Parameter Store
aws ssm put-parameter \
  --name "/icara/database-url" \
  --value "postgresql://user:pass@rds-endpoint:5432/icara_production?sslmode=require" \
  --type "SecureString" \
  --description "Calculator platform database connection"

aws ssm put-parameter \
  --name "/icara/nextauth-secret" \
  --value "$(openssl rand -base64 32)" \
  --type "SecureString" \
  --description "NextAuth.js secret for calculator platform"

aws ssm put-parameter \
  --name "/icara/encryption-key" \
  --value "$(openssl rand -base64 32)" \
  --type "SecureString" \
  --description "Encryption key for sensitive calculator data"

aws ssm put-parameter \
  --name "/icara/auth0-client-secret" \
  --value "your-auth0-client-secret" \
  --type "SecureString" \
  --description "Auth0 client secret for financial services authentication"

aws ssm put-parameter \
  --name "/icara/redis-url" \
  --value "rediss://username:password@redis-endpoint:6380" \
  --type "SecureString" \
  --description "Redis connection for calculation caching"

# Calculator-specific configuration
aws ssm put-parameter \
  --name "/icara/calculation-audit-retention" \
  --value "2557" \
  --type "String" \
  --description "Calculator audit log retention in days (7 years)"

aws ssm put-parameter \
  --name "/icara/regulatory-reporting-endpoint" \
  --value "https://api.fca.org.uk/regulatory-reporting" \
  --type "SecureString" \
  --description "FCA regulatory reporting endpoint"
```

#### Field-Level Encryption for Calculator Data
```typescript
// lib/encryption.ts - Enhanced encryption for financial data
import crypto from 'crypto';

export class CalculatorDataEncryption {
  private static algorithm = 'aes-256-gcm';
  private static keyLength = 32;
  
  static encrypt(data: any): EncryptedData {
    const key = Buffer.from(process.env.ENCRYPTION_KEY!, 'base64');
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(this.algorithm, key);
    
    cipher.setAAD(Buffer.from('calculator-data'));
    
    let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    return {
      encrypted,
      iv: iv.toString('hex'),
      authTag: authTag.toString('hex'),
      algorithm: this.algorithm
    };
  }
  
  static decrypt(encryptedData: EncryptedData): any {
    const key = Buffer.from(process.env.ENCRYPTION_KEY!, 'base64');
    const decipher = crypto.createDecipher(
      encryptedData.algorithm,
      key
    );
    
    decipher.setAAD(Buffer.from('calculator-data'));
    decipher.setAuthTag(Buffer.from(encryptedData.authTag, 'hex'));
    
    let decrypted = decipher.update(encryptedData.encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return JSON.parse(decrypted);
  }
}

interface EncryptedData {
  encrypted: string;
  iv: string;
  authTag: string;
  algorithm: string;
}
```

### 2. Database Security for Calculator Platform

#### Connection Security with SSL
```bash
# Configure SSL connection for calculator platform
export DATABASE_URL="postgresql://user:pass@rds-endpoint:5432/icara_production?sslmode=require&sslcert=rds-ca-2019-root.pem&sslrootcert=rds-ca-2019-root.pem"

# Download RDS SSL certificate
wget https://s3.amazonaws.com/rds-downloads/rds-ca-2019-root.pem
```

#### Enhanced Row Level Security for Calculator Data
```sql
-- Enhanced RLS policies for calculator platform
-- Run in production database

-- Enable RLS on all calculator tables
ALTER TABLE calculations ENABLE ROW LEVEL SECURITY;
ALTER TABLE calculation_drafts ENABLE ROW LEVEL SECURITY;
ALTER TABLE firms ENABLE ROW LEVEL SECURITY;

-- Firm isolation policy for calculations
CREATE POLICY calculator_firm_isolation ON calculations
  FOR ALL
  TO authenticated
  USING (firm_id = current_setting('app.current_firm_id')::uuid);

-- User-based access for calculation drafts
CREATE POLICY calculator_draft_access ON calculation_drafts
  FOR ALL
  TO authenticated
  USING (
    firm_id = current_setting('app.current_firm_id')::uuid AND
    user_id = current_setting('app.current_user_id')::uuid
  );

-- Audit trail protection (read-only after creation)
CREATE POLICY calculator_audit_protection ON calculation_audit_log
  FOR SELECT
  TO authenticated
  USING (true);

CREATE POLICY calculator_audit_insert ON calculation_audit_log
  FOR INSERT
  TO authenticated
  WITH CHECK (user_id = current_setting('app.current_user_id')::uuid);

-- Function to set security context
CREATE OR REPLACE FUNCTION set_calculator_security_context(
  p_firm_id uuid,
  p_user_id uuid
) RETURNS void AS $$
BEGIN
  PERFORM set_config('app.current_firm_id', p_firm_id::text, true);
  PERFORM set_config('app.current_user_id', p_user_id::text, true);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## Monitoring and Observability

### 1. Calculator Platform Monitoring

#### Datadog Configuration for Financial Services
```typescript
// lib/monitoring/calculator-metrics.ts
import { StatsD } from 'node-statsd';
import tracer from 'dd-trace';

// Initialize Datadog tracer for calculator platform
tracer.init({
  service: 'icara-calculator-platform',
  env: process.env.NODE_ENV,
  version: process.env.VERCEL_GIT_COMMIT_SHA || 'unknown',
  tags: {
    'platform': 'calculator',
    'regulatory.version': process.env.REGULATORY_VERSION,
    'for.version': process.env.FOR_CALCULATOR_VERSION
  }
});

// StatsD client for calculator metrics
export const calculatorMetrics = new StatsD({
  host: process.env.DD_AGENT_HOST || 'localhost',
  port: parseInt(process.env.DD_DOGSTATSD_PORT || '8125'),
  prefix: 'icara.calculator.',
  tags: {
    environment: process.env.NODE_ENV,
    platform: 'calculator'
  }
});

// Calculator-specific metrics
export function trackCalculation(type: string, duration: number, accuracy: boolean) {
  calculatorMetrics.timing(`${type.toLowerCase()}.duration`, duration);
  calculatorMetrics.increment(`${type.toLowerCase()}.count`);
  calculatorMetrics.increment(`${type.toLowerCase()}.accuracy`, 1, [`accurate:${accuracy}`]);
}

export function trackCalculationError(type: string, error: string) {
  calculatorMetrics.increment(`${type.toLowerCase()}.error`, 1, [`error_type:${error}`]);
}

export function trackUserActivity(action: string, calculatorType: string) {
  calculatorMetrics.increment('user.activity', 1, [
    `action:${action}`,
    `calculator:${calculatorType}`
  ]);
}

// Regulatory compliance metrics
export function trackRegulatoryCompliance(calculationType: string, compliant: boolean) {
  calculatorMetrics.increment('regulatory.compliance', 1, [
    `calculator:${calculationType}`,
    `compliant:${compliant}`
  ]);
}

// Performance metrics for complex calculations
export function trackCalculationPerformance(
  calculationType: string,
  inputSize: number,
  processingTime: number,
  memoryUsage: number
) {
  calculatorMetrics.histogram(`${calculationType.toLowerCase()}.input_size`, inputSize);
  calculatorMetrics.timing(`${calculationType.toLowerCase()}.processing_time`, processingTime);
  calculatorMetrics.gauge(`${calculationType.toLowerCase()}.memory_usage`, memoryUsage);
}
```

#### Enhanced Health Check for Calculator Platform
```typescript
// app/api/health/calculators/route.ts
import { NextResponse } from 'next/server';
import { db } from '@/lib/db';
import { FORCalculator, KFRCalculator, KTCDCalculator, RiskCalculator } from '@icara/calculators';

export async function GET() {
  const startTime = Date.now();
  const healthChecks: Record<string, any> = {};
  
  try {
    // Database connectivity
    await db.$queryRaw`SELECT 1`;
    healthChecks.database = { status: 'healthy', responseTime: Date.now() - startTime };
    
    // Redis connectivity
    if (process.env.REDIS_URL) {
      // Redis health check
      healthChecks.redis = { status: 'healthy' };
    }
    
    // Calculator engine health checks
    const calculatorTests = {
      for: () => FORCalculator.healthCheck(),
      kfr: () => KFRCalculator.healthCheck(),
      ktcd: () => KTCDCalculator.healthCheck(),
      risk: () => RiskCalculator.healthCheck()
    };
    
    for (const [name, test] of Object.entries(calculatorTests)) {
      try {
        const result = await test();
        healthChecks[`calculator_${name}`] = { 
          status: 'healthy', 
          version: result.version,
          regulatory: result.regulatoryCompliance
        };
      } catch (error) {
        healthChecks[`calculator_${name}`] = { 
          status: 'unhealthy', 
          error: error instanceof Error ? error.message : 'Unknown error' 
        };
      }
    }
    
    const responseTime = Date.now() - startTime;
    const allHealthy = Object.values(healthChecks).every(check => check.status === 'healthy');
    
    return NextResponse.json({
      status: allHealthy ? 'healthy' : 'degraded',
      timestamp: new Date().toISOString(),
      responseTime,
      version: {
        app: process.env.VERCEL_GIT_COMMIT_SHA || 'unknown',
        regulatory: process.env.REGULATORY_VERSION || 'unknown',
        for: process.env.FOR_CALCULATOR_VERSION || 'unknown'
      },
      environment: process.env.NODE_ENV,
      platform: 'calculator',
      checks: healthChecks
    }, { 
      status: allHealthy ? 200 : 503,
      headers: {
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'X-Health-Check': 'calculator-platform'
      }
    });
  } catch (error) {
    return NextResponse.json({
      status: 'unhealthy',
      error: error instanceof Error ? error.message : 'Unknown error',
      timestamp: new Date().toISOString(),
      responseTime: Date.now() - startTime
    }, { status: 503 });
  }
}
```

### 2. Error Tracking and Alerting

#### Sentry Configuration for Calculator Platform
```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  
  // Calculator-specific configuration
  tags: {
    platform: 'calculator',
    regulatory_version: process.env.REGULATORY_VERSION,
    for_version: process.env.FOR_CALCULATOR_VERSION
  },
  
  beforeSend(event, hint) {
    // Filter calculator-specific errors
    if (event.exception) {
      const error = hint.originalException;
      
      // Don't send calculation validation errors (they're expected)
      if (error && error.name === 'CalculationValidationError') {
        return null;
      }
      
      // Don't send regulatory compliance test failures in development
      if (process.env.NODE_ENV === 'development' && 
          error && error.message?.includes('regulatory compliance')) {
        return null;
      }
    }
    
    // Add calculator context to all events
    if (event.request?.url?.includes('/calculator/')) {
      event.tags = {
        ...event.tags,
        calculator_context: true,
        calculator_type: event.request.url.split('/calculator/')[1]?.split('/')[0]
      };
    }
    
    return event;
  },
  
  // Enhanced error grouping for calculator platform
  fingerprint: ['{{ default }}', '{{ platform }}', '{{ calculator_type }}']
});
```

---

## Backup and Disaster Recovery

### 1. Calculator Data Backup Strategy

#### Automated Backup for Calculation Data
```bash
#!/bin/bash
# scripts/backup-calculator-data.sh

set -e

# Configuration
DB_HOST="${DB_HOST:-production-db-endpoint}"
DB_PORT="${DB_PORT:-5432}"
DB_NAME="${DB_NAME:-icara_production}"
DB_USER="${DB_USER:-icara_admin}"
BACKUP_DIR="/backups/calculator-data"
S3_BUCKET="icara-platform-calculator-backups"
RETENTION_DAYS=2557  # 7 years (regulatory requirement)

# Create backup filename with timestamp
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="${BACKUP_DIR}/calculator_data_${TIMESTAMP}.sql.gz"

# Create backup directory
mkdir -p $BACKUP_DIR

# Perform calculation data backup with specific tables
echo "Starting calculator data backup..."
pg_dump -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME \
  --table=calculations \
  --table=calculation_drafts \
  --table=calculation_audit_log \
  --table=firms \
  --verbose \
  --no-password | gzip > $BACKUP_FILE

# Verify backup integrity
echo "Verifying backup integrity..."
gunzip -t $BACKUP_FILE

# Upload to S3 with calculator-specific path
echo "Uploading backup to S3..."
aws s3 cp $BACKUP_FILE s3://$S3_BUCKET/calculator-data/ \
  --storage-class DEEP_ARCHIVE \
  --metadata purpose=calculator-backup,retention-years=7

# Create backup manifest
cat > "${BACKUP_DIR}/manifest_${TIMESTAMP}.json" << EOF
{
  "backup_id": "calculator_${TIMESTAMP}",
  "timestamp": "$(date -Iseconds)",
  "type": "calculator_data",
  "size_bytes": $(stat -c%s "$BACKUP_FILE"),
  "tables": ["calculations", "calculation_drafts", "calculation_audit_log", "firms"],
  "regulatory_retention": "7_years",
  "s3_location": "s3://$S3_BUCKET/calculator-data/calculator_data_${TIMESTAMP}.sql.gz"
}
EOF

aws s3 cp "${BACKUP_DIR}/manifest_${TIMESTAMP}.json" s3://$S3_BUCKET/manifests/

# Clean up local backup (keep manifest)
rm $BACKUP_FILE

# Clean up old S3 backups (beyond regulatory retention)
echo "Cleaning up old backups..."
CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" -Iso)

aws s3api list-objects-v2 \
  --bucket $S3_BUCKET \
  --prefix calculator-data/ \
  --query "Contents[?LastModified<='$CUTOFF_DATE'].Key" \
  --output text | xargs -r -I {} aws s3 rm s3://$S3_BUCKET/{}

echo "Calculator data backup completed successfully"
```

#### Backup Automation with Enhanced Monitoring
```yaml
# .github/workflows/calculator-backup.yml
name: Calculator Data Backup

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Type of backup'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - incremental
        - audit_only

jobs:
  backup-calculator-data:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-2
    
    - name: Run calculator data backup
      env:
        DB_HOST: ${{ secrets.PRODUCTION_DB_HOST }}
        DB_USER: ${{ secrets.PRODUCTION_DB_USER }}
        PGPASSWORD: ${{ secrets.PRODUCTION_DB_PASSWORD }}
        BACKUP_TYPE: ${{ github.event.inputs.backup_type || 'full' }}
      run: |
        chmod +x scripts/backup-calculator-data.sh
        ./scripts/backup-calculator-data.sh
    
    - name: Verify backup completion
      run: |
        # Verify latest backup exists in S3
        LATEST_BACKUP=$(aws s3 ls s3://icara-platform-calculator-backups/calculator-data/ \
          --recursive | sort | tail -n 1 | awk '{print $4}')
        
        if [[ -z "$LATEST_BACKUP" ]]; then
          echo "ERROR: No backup found in S3"
          exit 1
        fi
        
        echo "Latest backup: $LATEST_BACKUP"
        
        # Test backup restoration (to temporary location)
        aws s3 cp s3://icara-platform-calculator-backups/$LATEST_BACKUP /tmp/test-backup.sql.gz
        gunzip -t /tmp/test-backup.sql.gz
        
        echo "Backup verification successful"
    
    - name: Update backup monitoring
      run: |
        # Update CloudWatch metric for backup success
        aws cloudwatch put-metric-data \
          --namespace "ICARA/Calculator/Backup" \
          --metric-data MetricName=BackupSuccess,Value=1,Unit=Count
    
    - name: Notify backup completion
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#infrastructure'
        text: 'Calculator data backup completed successfully'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      if: always()
```

### 2. Disaster Recovery for Calculator Platform

#### Recovery Procedures
```bash
#!/bin/bash
# scripts/restore-calculator-data.sh

set -e

if [ $# -lt 2 ]; then
    echo "Usage: $0 <backup-s3-key> <target-database>"
    echo "Example: $0 calculator-data/calculator_data_20250627_140000.sql.gz icara_restored"
    exit 1
fi

BACKUP_S3_KEY=$1
TARGET_DB=$2
RESTORE_DIR="/tmp/calculator-restore"
LOCAL_BACKUP="$RESTORE_DIR/restore.sql.gz"

echo "=== Calculator Data Recovery Process ==="
echo "Backup: s3://icara-platform-calculator-backups/$BACKUP_S3_KEY"
echo "Target Database: $TARGET_DB"

# Create restore directory
mkdir -p $RESTORE_DIR

echo "Downloading backup from S3..."
aws s3 cp s3://icara-platform-calculator-backups/$BACKUP_S3_KEY $LOCAL_BACKUP

# Verify backup integrity
echo "Verifying backup integrity..."
gunzip -t $LOCAL_BACKUP

# Create target database
echo "Creating target database..."
createdb $TARGET_DB

# Restore calculator data
echo "Restoring calculator data..."
gunzip -c $LOCAL_BACKUP | psql $TARGET_DB

# Verify restoration
echo "Verifying restoration..."
RESTORED_CALCULATION_COUNT=$(psql -t -c "SELECT COUNT(*) FROM calculations;" $TARGET_DB)
echo "Restored calculations: $RESTORED_CALCULATION_COUNT"

RESTORED_FIRM_COUNT=$(psql -t -c "SELECT COUNT(*) FROM firms;" $TARGET_DB)
echo "Restored firms: $RESTORED_FIRM_COUNT"

# Run calculation integrity checks
echo "Running calculation integrity checks..."
psql $TARGET_DB << 'EOF'
-- Verify calculation data integrity
SELECT 
  type,
  COUNT(*) as count,
  MIN(created_at) as earliest,
  MAX(created_at) as latest
FROM calculations 
GROUP BY type;

-- Verify audit trail integrity
SELECT COUNT(*) as audit_records FROM calculation_audit_log;

-- Check for orphaned records
SELECT COUNT(*) as orphaned_calculations 
FROM calculations c 
LEFT JOIN firms f ON c.firm_id = f.id 
WHERE f.id IS NULL;
EOF

echo "Calculator data restoration completed successfully"
echo ""
echo "Next steps:"
echo "1. Review restored data integrity"
echo "2. Test calculator functionality"
echo "3. Switch application to restored database if needed"
echo "4. Update DNS/load balancer if switching databases"

# Clean up
rm -rf $RESTORE_DIR
```

#### Disaster Recovery Testing
```bash
#!/bin/bash
# scripts/test-disaster-recovery.sh

echo "=== Calculator Platform Disaster Recovery Test ==="

# Test database restoration
echo "Testing database restoration..."
LATEST_BACKUP=$(aws s3 ls s3://icara-platform-calculator-backups/calculator-data/ \
  --recursive | sort | tail -n 1 | awk '{print $4}')

if [[ -z "$LATEST_BACKUP" ]]; then
  echo "ERROR: No backup found for testing"
  exit 1
fi

# Restore to test database
./scripts/restore-calculator-data.sh $LATEST_BACKUP icara_test_restore

# Test calculator functionality on restored data
echo "Testing calculator functionality on restored data..."
DATABASE_URL="postgresql://postgres:password@localhost:5432/icara_test_restore" \
pnpm test:calculator-functionality

# Test data migration compatibility
echo "Testing data migration compatibility..."
cd packages/database
DATABASE_URL="postgresql://postgres:password@localhost:5432/icara_test_restore" \
pnpm prisma migrate diff

# Clean up test database
dropdb icara_test_restore

echo "Disaster recovery test completed successfully"
```

This comprehensive deployment guide ensures your sophisticated calculator platform (FOR 2.0, KFR with SNI intelligence, industry-first SA-CCR implementation, and advanced risk assessment) can be deployed to enterprise-grade production environments with proper security, monitoring, and disaster recovery capabilities.