# ICARA/MiFIDPRU Platform Master Context
## Comprehensive Development Reference for Claude Code Operations

---
*last updated: 26 November 2025**
## PROJECT OVERVIEW
**Linked Files**  [[strategic_framework_complete_project_PRISM]]; [[0. master_context_PRISM]]  [[02-Projects/PRISM/PRISM_MASTER_REFERENCE|PRISM_MASTER_REFERENCE]]  
[[PRISM-Hub]]
[[architecture]]

### Platform Identity
- **Name**:  Prudential Risk & Intelligence System Platform (PRISM)
- **Governing Regulations**  https://handbook.fca.org.uk/handbook?entityId=mifidpru
- **Purpose**: Enterprise regulatory compliance platform for UK investment firms fulfilment of obligations under the MiFiDPru regulations which prescribe the formula and procedure for firms to calculate and interpret their respective minimum regulatory capital requirement - known as the ICARA (individual capital adequacy and risk assessment) procedure.  This Prism-product/project systematically builds, processes and calculates ALL the variables necessary to effectively calculate the firms regulatory minimum capital requirement, how its comprised and why and enables effective signposting of key financial metrics that may impact or change the minimum capital requirement.
- **Components/Modules of PRISM**
	- Foundational Modules:
		- *Firm Data*:  Basic info; Regulatory Permissions Profile; SNI/NON-SNI Status; K-Factor profile based on Permissions.
		- *Financial Data*:  Balance sheet and Regulatory metrics data
	- Core ICARA Modules:
		- *Fixed Overhead Requirement* calculator
		- *Risk Assessment* Risk Assessment Profile & Capital allocation calculator
		- *Wind Down Assessment* Calculator
		- *K-Factor Requirement* (KFR) - Comprising of 9 possible k-factors across 3 risk categories: Risk to Firm; Risk to Client and Risk to Market
		- *Linear/Reverse Stress Test* - simulation and calculation
	- Macro-Modules:
		- *SMCR* - Senior Management & Certification Regime
		- *Reporting Module* - report generation across PRISM system:  comprehensive or individual or user-selected combination
		- *Historical Data* - data base driven storage/archiving of historical snapshots of ICARA position across time; essential data-persistence and database preservation
		- *User Management*:  creation of various user profiles with and under the Firm; ability to define access, read/write/edit permissions - defined from SMCR module with allocation of senior mgmt owners for sign off; with employee level contribution within predefined modules/granularity
	- *Intelligence Dashboard* - dashboard consolidating all relevant modules; undertaking real time calculations of master minimum regulatory capital minimum formula; display of module calculations; calculation of various capital and risk metrics, variables and ratio's; stress test effects and intelligent mgmt data information and advice // to be supplemented with embedded AI-intelligence.  [this module has not been developed/implemented yet - this work is scheduled and critically important as it will be the main intelligence window into the whole application]  
	
- **Industry Context**: Market First / Revolutionary replacement for current manual consultant-dependent/driven processes
- **Commercial Impact**: 90%+ time reduction, significant cost savings, 100% effective regulatory compliance, crucial management information, intelligence and monitoring capabilities, comprehensive report generation features; persistent database of historical data and comparative analysis

### Project Scope Summary
- **Total Modules**: 22:  Foundational: 2 ; Core: 15; Macro: 5
- **Current Status**: Outstanding Modules:  Intelligence Dashboard; Reporting Module; User Mgmt; Historical Data.  Database: still to be designed, developed and implemented to function across intended scope of application
- **Architecture**: TypeScript/React enterprise platform migration from proven HTML prototypes
- **Development Model**: Solo founder + AI-assisted development with strategic facilitators

---

## REGULATORY CONTEXT & COMPLIANCE REQUIREMENTS

### Primary Regulatory Framework
- **Jurisdiction**: United Kingdom - Financial Conduct Authority (FCA)
- **Core Regulation**: MiFIDPRU (Investment Firms Prudential Regime)
- **Supporting Framework**: ICARA (Internal Capital Adequacy and Risk Assessment)
- **Compliance Standard**: Institutional investment firm requirements
- **Audit Requirement**: 7-year data retention with complete calculation audit trail

### Critical Regulatory Articles
- **MiFIDPRU 4.3**: MCR Calculation (max of OFR, WDA, RA)
- **MiFIDPRU 4.5**: Fixed Overhead Requirement (FOR) - 25% of prescribed costs
- **MiFIDPRU 4.6**: K-Factor Requirements (KFR) with SNI classification
- **MiFIDPRU 4.10-4.15**: Specific K-factor methodologies
- **MiFIDPRU 7.7**: ICARA documentation and risk assessment
- **CRR Articles 274-280**: SA-CCR methodology for K-TCD calculations

### Non-Negotiable Compliance Standards
1. **Calculation Accuracy**: 100% parity with regulatory examples (penny-perfect)
2. **Audit Trail**: Complete user action and calculation history logging
3. **Data Retention**: 7-year regulatory compliance with secure storage
4. **Regulatory Reporting**: FCA-ready export formats and documentation
5. **Access Control**: SMCR-aligned permissions and responsibility matrices

---

## COMPLETE MODULE INVENTORY

### Core Modules (12 Total)

#### Completed Core Modules (6)
1. **FOR Calculator**
   - **Function**: Fixed Overhead Requirement calculation per MiFIDPRU 4.5
   - **Features**: Dual approach (consolidated/granular), 6 categories, 24 subcategories, scenario planning
   - **Source**: `FORCalc_.html` (proven HTML prototype)
   - **Key Innovation**: Industry-first granular cost tracking with regulatory adjustments

2. **KFR Calculator** 
   - **Function**: K-Factor Requirement calculation per MiFIDPRU 4.6
   - **Features**: SNI classification intelligence, all 9 K-factors, threshold monitoring
   - **Source**: `kfactorcalc.html` with SNI logic
   - **Key Innovation**: Real-time SNI threshold monitoring with predictive analytics

3. **WDA Calculator**
   - **Function**: Wind-Down Assessment per MiFIDPRU 4.3
   - **Features**: 3-24 month timeline, critical path tracking, stress scenarios
   - **Source**: `winddowncostcalc_enhanced_claude4.html`
   - **Key Innovation**: Dynamic timeline optimization with cascading cost analysis

4. **RA Calculator**
   - **Function**: Risk Assessment per MiFIDPRU 7.7
   - **Features**: Multi-dimensional scoring, controls effectiveness, correlation modeling
   - **Source**: `riskassessalc_claude4.html`
   - **Key Innovation**: Advanced velocity factors and portfolio correlation analysis

5. **Financial Data Module**
   - **Function**: Centralized financial statements and prudential data collection
   - **Features**: Balance sheet validation, live Own Funds summary, regulatory capital components
   - **Source**: Custom data collection interface
   - **Key Innovation**: Real-time financial data validation with regulatory compliance checks

6. **Firm & SMCR Data Module**
   - **Function**: Corporate, regulatory, and SMCR personnel data management
   - **Features**: Dynamic address fields, permissions matrix, SMF-specific data, K-factor relevance engine
   - **Source**: Comprehensive firm data collection system
   - **Key Innovation**: SMCR-aligned data management with automatic K-factor applicability determination

#### [Initial POC Drafted - For Review/CC] Core Modules (2)
7. **Stress Test Module**
   - **Function**: Dynamic stress testing with cascading effects
   - **Features**: Scenario library, correlation modeling, waterfall analysis
   - **Status**: Work in Progress

8. **Reverse Stress Test**
   - **Function**: AI-powered failure point discovery
   - **Features**: Multi-objective optimization, Monte Carlo engine, 3D visualization
   - **Status**: Work in Progress

#### Planned Core Modules - Draft POC drafted - For Review & Update/CC (4)
9. **Intelligence Dashboard**--UPDATE as of 13072025:  Prototype drafted--
   - **Function**: Real-time MCR tracking and insights
   - **Features**: Live calculations, predictive analytics, risk radar

10. **Historical Data**--UPDATE as of 13072025:  Prototype drafted--
    - **Function**: Time-series analysis and pattern recognition
    - **Features**: Trend analysis, anomaly detection, forecasting

11. **Reporting Module**--UPDATE as of 13072025:  Prototype drafted--
    - **Function**: Automated regulatory and management reporting
    - **Features**: MIF007 automation, smart narratives, multi-format export

12. **User Management** --UPDATE as of 13072025:  Prototype drafted--
    - **Function**: SMCR-aligned access control and audit
    - **Features**: Role mapping, responsibility matrix, full audit trail

### Supplementary Modules (4 Total - All Complete & integrated into core KFR module)

latest /dev implementation: (see latest session_wrap_xx.md file)
1. **K-CON Calculator**
   - **Function**: Concentration Risk calculation per MiFIDPRU 4.15
   - **Features**: EVE calculation, risk weighting, connected counterparty grouping
   - **Source** POC file: `kcon-calculator.html`
   - **Integration**: Feeds into KFR Calculator

2. **K-NPR Calculator**
   - **Function**: Net Position Risk calculation per MiFIDPRU 4.10
   - **Features**: Multi-risk coverage (FX, Commodity, Options), automatic netting
   - **Source** POC file: `knpr-calculator.html`
   - **Integration**: Feeds into KFR Calculator

3. **K-CMG Calculator**
   - **Function**: Clearing Member Guarantee calculation per MiFIDPRU 4.14
   - **Features**: Multi-CCP management, historical tracking, efficiency metrics
   - **Source** POC file: `kcmg-calculator.html`
   - **Integration**: Feeds into KFR Calculator

4. **K-TCD Calculator**
   - **Function**: Trading Counterparty Default calculation per MiFIDPRU 4.12
   - **Features**: Full SA-CCR methodology (RC, PFE, EAD), netting set management
   - **Source** POC file: `ktcd-calculator.html`
   - **Key Innovation**: Industry-first web-based SA-CCR implementation

---

## TECHNICAL ARCHITECTURE STANDARDS

### Technology Stack Requirements
```yaml
Frontend:
  Framework: Next.js 14 + React 18
  Language: TypeScript (strict mode)
  Styling: Tailwind CSS + CSS Modules
  State: Zustand + React Query
  Validation: Zod schemas
  Charts: Chart.js + D3.js for advanced visualizations

Backend:
  Runtime: Node.js 20
  API: tRPC for type-safe APIs
  Database: PostgreSQL 15 + TimescaleDB for time-series
  Caching: Redis 7
  Real-time: WebSockets for live updates

Infrastructure:
  Hosting: Vercel (primary) / AWS ECS (alternative)
  CDN: CloudFlare with regulatory compliance
  CI/CD: GitHub Actions
  Monitoring: Datadog + Sentry
  Security: Auth0/Clerk with SMCR alignment
```

### Code Quality Standards

#### TypeScript Requirements
- **Strict Mode**: Enabled with no `any` types in calculation logic
- **Interface Design**: Comprehensive Zod schemas for all data structures
- **Error Handling**: Regulatory-context aware error classes
- **Documentation**: JSDoc comments with regulatory references

#### Financial Calculation Standards
```typescript
// REQUIRED: Use Decimal.js for all financial mathematics
import { Decimal } from 'decimal.js';

// REQUIRED: Penny-perfect accuracy
function calculateFOR(prescribedCosts: number): number {
  const forValue = prescribedCosts * 0.25;
  return Math.round(forValue * 100) / 100; // Penny accuracy
}

// REQUIRED: Comprehensive regulatory documentation
/**
 * Calculate Fixed Overhead Requirement (FOR) per MiFIDPRU 4.5
 * @param prescribedCosts - Annual prescribed costs in GBP
 * @returns FOR value (25% of prescribed costs) rounded to nearest penny
 * @regulatory MiFIDPRU 4.5.1R: FOR = 25% of prescribed costs
 */
```

#### Performance Requirements
- **API Response Time**: <200ms for standard calculations
- **Complex Calculations**: <500ms for multi-module operations (K-TCD SA-CCR)
- **Concurrent Users**: Support 1000+ simultaneous calculations
- **Memory Management**: No memory leaks in repeated calculations

---

## ESTABLISHED DEVELOPMENT PATTERNS

### Module Structure Template
```
modules/[category]/[module-name]/
├── .claude.md                      # Module-specific context
├── legacy/
│   └── [source-file].html         # Source HTML prototype
├── src/
│   ├── components/
│   │   ├── [Module]Calculator.tsx  # Main component
│   │   ├── [Module]Form.tsx        # Input form
│   │   └── [Module]Results.tsx     # Results display
│   ├── api/
│   │   └── [module].ts             # tRPC API routes
│   ├── types/
│   │   └── [module].ts             # TypeScript interfaces
│   ├── utils/
│   │   └── calculations.ts         # Calculation engine
│   └── validation/
│       └── schemas.ts              # Zod validation schemas
├── tests/
│   ├── calculations.test.ts        # Calculation accuracy tests
│   ├── cross-validation.test.ts    # HTML prototype comparison
│   ├── integration.test.ts         # Module integration tests
│   └── performance.test.ts         # Performance benchmarks
└── docs/
    ├── methodology.md              # Regulatory calculation methodology
    ├── api.md                      # API documentation
    └── integration.md              # Integration guide
```

### Proven Integration Patterns

#### Data Flow Architecture
```typescript
// Established pattern for module interconnectivity
interface ModuleDataFlow {
  input: {
    directEntry: UserInput;
    moduleIntegration: OtherModuleOutput;
    regulatoryData: RegulatoryParameters;
  };
  
  processing: {
    validation: ZodValidation;
    calculation: RegulatoryCalculation;
    auditTrail: AuditLogEntry;
  };
  
  output: {
    results: CalculationResults;
    integration: IntegrationData;
    export: RegulatoryExport;
  };
}
```

#### Cross-Module Integration Standards
1. **KFR Integration**: All K-factor calculators feed results to KFR Calculator
2. **MCR Aggregation**: FOR, KFR, WDA, RA all feed to master MCR calculation
3. **Real-time Updates**: WebSocket events for live calculation updates
4. **Audit Consistency**: Unified audit trail across all modules

---

## QUALITY ASSURANCE REQUIREMENTS

### Test Coverage Standards
- **Unit Tests**: 95%+ coverage for calculation functions
- **Integration Tests**: Complete module interconnectivity validation
- **Cross-Validation**: 100% parity with HTML prototype calculations
- **Performance Tests**: Benchmark compliance for all calculation types
- **Regulatory Tests**: Validation against FCA examples and standards

### Validation Requirements
```typescript
// REQUIRED: Cross-validation test pattern
describe('[Module] Cross-Validation', () => {
  htmlReferenceData.forEach((testCase) => {
    test(`${testCase.id}: ${testCase.description}`, () => {
      const reactResult = ModuleCalculator.calculate(testCase.input);
      const htmlResult = testCase.htmlResult;
      
      // Penny-perfect accuracy requirement
      const deviation = Math.abs(reactResult.value - htmlResult.value);
      expect(deviation).toBeLessThanOrEqual(0.01);
    });
  });
});
```

### Regulatory Compliance Validation
- **Calculation Methodology**: Review against current regulatory standards
- **Audit Trail**: Complete user action and calculation history
- **Data Retention**: 7-year compliance with secure encrypted storage
- **Export Formats**: FCA-ready reporting and documentation

---

## INTEGRATION & DATA FLOW REQUIREMENTS

### Master Calculation Flow
```
Financial Data Module → [Provides base financial information]
    ↓
Firm & SMCR Data → [Provides firm classification and business activity data]
    ↓
FOR Calculator → [Calculates fixed overhead requirement]
    ↓
K-Factor Calculators (9 KFR's) → [Calculate component K-factors]
    ↓
KFR Calculator → [Sums total K-factors with SNI intelligence]
    ↓
WDA Calculator → [Calculates wind-down assessment]
    ↓
RA Calculator → [Calculates risk assessment capital]
    ↓
MCR Aggregation → [max(FOR+KFR, WDA, RA)] → Master Capital Requirement
    ↓
Intelligence Dashboard → [Real-time monitoring and analytics]
    ↓
Reporting Module → [Automated regulatory reporting]
```

### Real-Time Update Architecture
- **WebSocket Integration**: Live calculation updates across all modules
- **State Management**: Zustand for application state, React Query for server state
- **Caching Strategy**: Redis for calculation caching, optimistic updates for UI

---

## REGULATORY DOCUMENTATION STANDARDS

### Required Documentation Elements
1. **Calculation Methodology**: Detailed regulatory basis for each calculation
2. **Audit Trail Documentation**: Complete user action and calculation logging
3. **API Documentation**: Comprehensive endpoint documentation with examples
4. **Integration Guides**: Module interconnectivity and data flow documentation
5. **Regulatory Compliance Reports**: FCA-ready documentation packages

### Documentation Templates
```markdown
# [Module Name] Regulatory Methodology

## Regulatory Basis
- Primary Regulation: [MiFIDPRU Article]
- Supporting Regulations: [Additional references]
- Implementation Date: [Date]
- Last Review: [Date]

## Calculation Methodology
[Detailed step-by-step calculation process]

## Validation Evidence
[Cross-references to regulatory examples and validation tests]

## Audit Trail Requirements
[Description of logged activities and data retention]
```

---

## PERFORMANCE & SCALABILITY STANDARDS

### Response Time Requirements
- **Simple Calculations** (FOR, basic K-factors): <50ms
- **Standard Calculations** (KFR, WDA, RA): <200ms
- **Complex Calculations** (K-TCD SA-CCR, multi-module): <500ms
- **System Integration** (Full MCR calculation): <1000ms

### Scalability Targets
- **Concurrent Users**: 1000+ simultaneous calculations
- **Data Volume**: Support for 10+ years of historical calculation data
- **Module Scalability**: Architecture supports addition of new regulatory modules
- **Geographic Distribution**: Multi-region deployment capability

---

## SECURITY & COMPLIANCE REQUIREMENTS

### Data Protection Standards
- **Encryption**: AES-256 for data at rest, TLS 1.3 for data in transit
- **Access Control**: SMCR-aligned role-based access with audit trail
- **Data Retention**: 7-year regulatory compliance with secure deletion
- **Audit Logging**: Complete user action tracking with regulatory metadata

### Authentication & Authorization
- **Primary Auth**: Auth0/Clerk with financial services compliance
- **Multi-Factor Authentication**: Required for all production access
- **Session Management**: Secure token-based with appropriate expiration
- **Role-Based Access**: SMCR Senior Manager Function alignment

---

## DEVELOPMENT EXECUTION GUIDELINES

### Claude Code Operation Standards
1. **Context Requirements**: Always include this master context file
2. **Module Context**: Include relevant module-specific .claude.md file
3. **Regulatory Focus**: Emphasize compliance and audit requirements in all prompts
4. **Integration Awareness**: Consider impact on existing completed modules
5. **Performance Monitoring**: Include performance benchmarking in all implementations

### Quality Gates
- **Pre-Implementation**: Regulatory requirement validation
- **Development**: Continuous testing against HTML prototypes
- **Integration**: Cross-module compatibility verification
- **Pre-Deployment**: Comprehensive regulatory compliance review
- **Post-Deployment**: Performance monitoring and audit trail validation

---

## SUCCESS CRITERIA & VALIDATION

### Technical Success Metrics
- **Calculation Accuracy**: 100% parity with HTML prototypes (non-negotiable)
- **Performance**: All response time targets met consistently
- **Integration**: Seamless data flow across all 18 modules
- **Reliability**: 99.9% uptime with graceful error handling
- **Security**: Zero security vulnerabilities in financial calculation logic

### Business Success Metrics
- **Regulatory Compliance**: FCA-ready with complete audit trail
- **Commercial Viability**: 90% time reduction vs consultant processes
- **Client Satisfaction**: Institutional client approval for production use
- **Market Impact**: Industry-first integrated ICARA/MiFIDPRU platform
- **Cost Effectiveness**: £100k+ savings per client vs traditional consulting

---

## CURRENT PROJECT STATUS

### Completion Summary (as of Week 8)
- **Total Progress**: 10/18 modules complete (55%)
- **Core Modules**: 6/12 complete (50%)
- **Supplementary Modules**: 4/4 complete (100%)
- **Current Phase**: Completing Stress Test and Reverse Stress Test modules
- **Next Phase**: Intelligence Dashboard and Historical Data modules

### Established Foundations
- **Proven Architecture**: Successful migration patterns established
- **Regulatory Validation**: FCA compliance confirmed across completed modules
- **Performance Standards**: All benchmarks met in production testing
- **Integration Framework**: Cross-module data flow validated and optimized

This master context serves as the definitive reference for all Claude Code operations on the ICARA/MiFIDPRU Platform (Project PRISM (Prudential & Risk Intelligence System Model). Every module development, integration, and validation activity must reference and comply with these standards to ensure regulatory compliance, technical excellence, and commercial success.